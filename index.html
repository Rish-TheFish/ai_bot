<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† DP AI Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 1200px;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            height: 90vh;
            min-height: 0;
        }
        .header {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            padding: 20px 20px 0 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        .chat-area {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 0;
            /* Remove fixed height */
        }
        .message {
            margin-bottom: 15px;
            padding: 20px 28px;
            border-radius: 22px;
            max-width: 90%;
            word-wrap: break-word;
            font-size: 1.05rem;
            line-height: 1.5;
        }
        .user-message {
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
            color: white;
            margin-left: auto;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .ai-message {
            background: #e9ecef;
            color: #333;
            border-left: 4px solid #87CEEB;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .input-area {
            padding: 20px;
            background: white;
            border-radius: 0 0 20px 20px;
            flex-shrink: 0;
        }
        .btn-custom {
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 10px 25px;
        }
        .btn-custom:hover {
            color: white;
        }
        .form-control {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 12px 20px;
        }
        .form-control:focus {
            border-color: #87CEEB;
            box-shadow: 0 0 0 0.2rem rgba(135, 206, 235, 0.25);
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #87CEEB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-upload-area {
            border: 2px dashed #87CEEB;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            margin: 20px 0;
        }
        .file-upload-area:hover {
            border-color: #B0E0E6;
            background: #e9ecef;
        }
        .hidden { display: none !important; }
        
        /* Disabled button styling */
        .disabled-btn {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            background: #6c757d !important;
            border-color: #6c757d !important;
            color: #ffffff !important;
        }
        .disabled-btn:hover {
            opacity: 0.5 !important;
            background: #6c757d !important;
            border-color: #6c757d !important;
            color: #ffffff !important;
        }
        .disabled-btn:active {
            opacity: 0.5 !important;
            background: #6c757d !important;
            border-color: #6c757d !important;
            color: #ffffff !important;
        }
        
        /* Short and detailed answer styling */
        .short-answer {
            font-weight: 500;
            color: #333;
            line-height: 1.4;
        }
        
        .answer-toggle {
            color: #87CEEB;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            text-decoration: underline;
            margin-top: 5px;
            display: inline-block;
        }
        
        .answer-toggle:hover {
            color: #B0E0E6;
        }
        
                .detailed-answer {
            margin-top: 10px;
            padding: 12px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            color: #495057;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .upload-anim, .delete-anim {
            position: relative;
            width: 750px;
            height: 200px;
        }
        .upload-anim .file-icon {
            position: absolute;
            font-size: 4em;
            color: #87CEEB;
            opacity: 1;
            animation: file-to-folder-arc 1.2s cubic-bezier(.4,2,.6,1) forwards;
        }
        .upload-anim .file-icon:nth-child(1) {
            left: -100px; top: 40px;
            animation-delay: 0s;
        }
        .upload-anim .file-icon:nth-child(2) {
            left: -100px; top: 40px;
            animation-delay: 0.2s;
        }
        .upload-anim .file-icon:nth-child(3) {
            left: -100px; top: 40px;
            animation-delay: 0.4s;
        }
        .upload-anim .folder-icon {
            position: absolute;
            right: 75px; bottom: 30px;
            font-size: 5em;
            color: #fbbf24;
        }
        .delete-anim .folder-icon {
            position: absolute;
            left: 75px; bottom: 30px;
            font-size: 5em;
            color: #fbbf24;
        }
        .delete-anim .file-icon {
            position: absolute;
            font-size: 4em;
            color: #87CEEB;
            opacity: 1;
            animation: file-from-folder-to-trash-arc 1.2s cubic-bezier(.4,2,.6,1) forwards;
        }
        .delete-anim .file-icon:nth-child(1) {
            left: 200px; top: 40px;
            animation-delay: 0.3s;
        }
        .delete-anim .file-icon:nth-child(2) {
            left: 200px; top: 40px;
            animation-delay: 0.5s;
        }
        .delete-anim .file-icon:nth-child(3) {
            left: 200px; top: 40px;
            animation-delay: 0.7s;
        }
        .delete-anim .trash-icon {
            position: absolute;
            right: 75px; bottom: 30px;
            font-size: 5em;
            color: #dc3545;
            opacity: 0.8;
            animation: trash-pop 1.2s cubic-bezier(.4,2,.6,1) forwards;
        }
        @keyframes file-to-folder-arc {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(600px, 0) scale(0.8); opacity: 0; }
        }
        @keyframes file-from-folder-to-trash-arc {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(450px, 0) scale(0.8); opacity: 0; }
        }
        @keyframes trash-pop {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        .disabled-chat-input { background: #e9ecef !important; color: #aaa !important; cursor: not-allowed !important; }
        .disabled-btn {
            background: #e9ecef !important;
            color: #aaa !important;
            cursor: not-allowed !important;
            opacity: 0.6;
            border-color: #e9ecef !important;
        }
        .message strong, .message b {
            font-size: 1.05em;
        }
        .message .emoji, .message span[style*="font-size"] {
            font-size: 1.5em !important;
            vertical-align: middle;
        }
        .chat-area, .logsArea {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        
        /* Source toggle styling */
        .source-toggle {
            cursor: pointer;
            color: #007bff;
            font-weight: bold;
            margin-left: 5px;
            user-select: none;
            transition: color 0.2s;
        }
        .source-toggle:hover {
            color: #0056b3;
        }
        .source-summary {
            font-weight: 500;
        }
        .source-detailed {
            margin-top: 8px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 100%;
            /* Removed height restriction to show full AI responses */
            overflow: visible;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <div class="header" style="position: relative; padding-bottom: 0;">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="d-flex flex-column align-items-start" style="min-width:180px;">
                        <!-- Empty space for balance -->
                    </div>
                    <h2 class="flex-grow-1 mb-0 text-center" style="color:white;"><i class="fas fa-brain"></i> DP AI Assistant</h2>
                    <div class="text-end" style="min-width:220px;">
                        <div class="mb-1">
                            <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                            <span id="statusText" style="font-size: 0.9em; font-weight: 500;">Disconnected</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between" style="height: 32px;">
                    <div class="btn-group" role="group" style="margin-left: 0;">
                        <button type="button" class="btn btn-toggle-chat active" id="chatTabBtn">
                            
                            <i class="fas fa-comments"></i> Chat
                        </button>
                        <button type="button" class="btn btn-toggle-chat" id="logsTabBtn">
                            <i class="fas fa-list"></i> Alerts
                        </button>
                        <button type="button" class="btn btn-toggle-chat" id="docsTabBtn">
                            <i class="fas fa-folder-open"></i> Docs
                        </button>
                    </div>
                    <div class="d-flex align-items-center">
                        <span id="userStatusText2" style="font-size: 1em; font-weight: 500; color: white;">Guest User</span>
                        <button class="btn btn-sm btn-outline-light ms-2" id="loginBtn2" style="font-size: 1em; font-weight: 500;">Login</button>
                        <button class="btn btn-sm btn-outline-light ms-1" id="registerBtn2" style="font-size: 1em; font-weight: 500;">Register</button>
                        <button class="btn btn-sm btn-outline-light ms-1 hidden" id="logoutBtn2" style="font-size: 1em; font-weight: 500;">Logout</button>
                    </div>
                </div>
            </div>
            <style>
            .header {
                background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                color: white;
                padding: 20px 20px 0 20px;
                border-radius: 20px 20px 0 0;
                text-align: center;
                position: relative;
                z-index: 2;
            }
            .btn-toggle-chat {
                background: transparent;
                color: white;
                border: none;
                border-radius: 12px 12px 0 0;
                margin-right: 4px;
                padding: 8px 24px 8px 20px;
                font-weight: 500;
                box-shadow: none;
                transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            }
            .btn-toggle-chat.active, .btn-toggle-chat:focus {
                background: #fff;
                color: #B0E0E6;
                box-shadow: 0 4px 12px rgba(135,206,235,0.10);
                z-index: 2;
                position: relative;
            }
            .btn-toggle-chat:not(.active):hover {
                background: rgba(255,255,255,0.15);
                color: #fff;
            }
            .chat-area, .logsArea {
                border-top-left-radius: 0;
                border-top-right-radius: 0;
            }
            </style>
            <!-- Welcome message above status, left-aligned -->
            <div class="chat-area" id="chatMessages">
                <div class="message ai-message">
                    <strong>ü§ñ AI Assistant:</strong> Welcome! I'm your DP AI Assistant. Please upload compliance documents or ask a question to get started.
                </div>
            </div>
            <div class="chat-area hidden" id="logsArea" style="height: calc(100vh - 200px); overflow-y: auto; position: relative;">
                <button class="btn btn-outline-secondary btn-sm" id="clearLogsBtn" style="position: fixed; top: 10px; right: 10px; z-index: 1000; background: white; border: 1px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <i class="fas fa-trash"></i> Clear
                </button>
                <div id="logsContent" style="padding-top: 50px;">
                <div class="message ai-message">
                    <strong>üìã System Logs:</strong> System activity and mode changes will appear here.
                    </div>
                </div>
            </div>
            <!-- Independent Document Management Area -->
            <div class="docs-area hidden" id="docsArea" style="height: calc(100vh - 200px); overflow-y: auto; padding: 20px; background: #f8f9fa;">
                <div class="message ai-message" style="background: transparent; color: #B0E0E6; border-left: none; margin-bottom: 0;">
                    <strong>Welcome to the Document Manager.</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 20px;">
                    <div class="d-flex align-items-center gap-3">
                        <h5 class="mb-0"><i class="fas fa-folder-open"></i> Document Management</h5>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="topicDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-tags"></i> <span id="currentTopicName">All Topics</span>
                            </button>
                            <ul class="dropdown-menu" id="topicDropdownMenu" style="min-width: 250px;">
                                <li><a class="dropdown-item" href="#" data-topic="all">üìÅ All Topics</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="createTopicBtn"><i class="fas fa-plus"></i> Create New Topic</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><div class="dropdown-item-text"><strong>Select Topics:</strong></div></li>
                                <li><div id="topicCheckboxes" class="px-3 py-2"></div></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item text-danger" href="#" id="deleteTopicsBtn" disabled><i class="fas fa-trash"></i> Delete Selected Topics</button></li>
                            </ul>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary" id="addDocBtn" style="width: 120px;"><i class="fas fa-plus"></i> Add Documents</button>
                        <button class="btn btn-danger" id="bulkDeleteBtn" style="width: 120px;" disabled><i class="fas fa-trash"></i> Delete Selected</button>
                        <button class="btn btn-warning" id="bulkReplaceBtn" style="width: 120px;" disabled><i class="fas fa-sync-alt"></i> Replace Selected</button>
                        <input type="file" id="addDocInput" class="d-none" multiple accept=".pdf,.docx,.txt,.csv,.xml">
                        <input type="file" id="bulkReplaceInput" class="d-none" accept=".pdf,.docx,.txt,.csv,.xml">
                    </div>
                </div>
                <table class="table table-striped table-hover bg-white rounded shadow-sm">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;"><input type="checkbox" id="selectAllCheckbox" class="form-check-input"></th>
                            <th>Name <span class="sort-arrow" data-col="name" style="cursor:pointer;">‚ñº</span></th>
                            <th>Topics <span class="sort-arrow" data-col="topics" style="cursor:pointer;">‚ñº</span></th>
                            <th>Type <span class="sort-arrow" data-col="type" style="cursor:pointer;">‚ñº</span></th>
                            <th>Uploaded <span class="sort-arrow" data-col="uploaded" style="cursor:pointer;">‚ñº</span></th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="docsTableBody">
                        <!-- Document rows will be inserted here -->
                        <tr><td colspan="6" class="text-center text-muted">No documents uploaded yet.</td></tr>
                    </tbody>
                </table>
            </div>
            <!-- Replace Document Modal -->
            <div class="modal fade" id="replaceDocModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Replace Document</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="replaceDocInput" accept=".pdf,.docx,.txt,.csv,.xml">
                            <input type="hidden" id="replaceDocName">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirmReplaceBtn">Replace</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filename Conflict Modal -->
            <div class="modal fade" id="filenameConflictModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Filename Conflict</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p id="conflictMessage">A file with this name already exists.</p>
                            <div class="mb-3">
                                <label for="newFilename" class="form-label">New Filename:</label>
                                <input type="text" class="form-control" id="newFilename" placeholder="Enter new filename">
                                <div class="form-text">Enter a new name for the file</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelConflictBtn">Cancel</button>
                            <button type="button" class="btn btn-primary" id="renameConflictBtn">Rename & Continue</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rename Document Modal -->
            <div class="modal fade" id="renameDocModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Rename Document</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="renameOldFilename" class="form-label">Current Name:</label>
                                <input type="text" class="form-control" id="renameOldFilename" readonly style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                            </div>
                            <div class="mb-3">
                                <label for="renameNewFilename" class="form-label">New Name:</label>
                                <input type="text" class="form-control" id="renameNewFilename" placeholder="Enter new filename">
                                <div class="form-text">Enter a new name for the file</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirmRenameBtn">Rename</button>
                        </div>
                    </div>
                </div>
            </div>
            
                         <!-- Create Topic Modal -->
             <div class="modal fade" id="createTopicModal" tabindex="-1">
                 <div class="modal-dialog">
                     <div class="modal-content">
                         <div class="modal-header">
                             <h5 class="modal-title">Create New Topic</h5>
                             <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                         </div>
                         <div class="modal-body">
                             <div class="mb-3">
                                 <label for="topicName" class="form-label">Topic Name:</label>
                                 <input type="text" class="form-control" id="topicName" placeholder="e.g., Compliance, Manual Guides, Policies">
                                 <div class="form-text">Enter a descriptive name for your topic</div>
                             </div>
                             <div class="mb-3">
                                 <label for="topicDescription" class="form-label">Description (Optional):</label>
                                 <textarea class="form-control" id="topicDescription" rows="3" placeholder="Brief description of what this topic contains..."></textarea>
                             </div>
                         </div>
                         <div class="modal-footer">
                             <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                             <button type="button" class="btn btn-primary" id="confirmCreateTopicBtn">Create Topic</button>
                         </div>
                     </div>
                 </div>
             </div>
             
             <!-- Delete Topics Confirmation Modal -->
             <div class="modal fade" id="deleteTopicsModal" tabindex="-1">
                 <div class="modal-dialog">
                     <div class="modal-content">
                         <div class="modal-header">
                             <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle"></i> Delete Topics</h5>
                             <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                         </div>
                         <div class="modal-body">
                             <p class="text-danger"><strong>Warning:</strong> This action cannot be undone.</p>
                             <p>Are you sure you want to delete the following topic(s)?</p>
                             <ul id="topicsToDeleteList" class="list-group mb-3">
                                 <!-- Topics will be listed here -->
                             </ul>
                             <div class="alert alert-warning">
                                 <i class="fas fa-info-circle"></i>
                                 <strong>Note:</strong> This will remove these tags from all documents, but the documents will remain in "All Topics".
                             </div>
                         </div>
                         <div class="modal-footer">
                             <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                             <button type="button" class="btn btn-danger" id="confirmDeleteTopicsBtn">
                                 <i class="fas fa-trash"></i> Delete Topics
                             </button>
                         </div>
                     </div>
                 </div>
             </div>
             
             <!-- Bulk Delete Documents Confirmation Modal -->
             <div class="modal fade" id="bulkDeleteModal" tabindex="-1">
                 <div class="modal-dialog">
                     <div class="modal-content">
                         <div class="modal-header">
                             <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle"></i> Delete Documents</h5>
                             <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                         </div>
                         <div class="modal-body">
                             <p class="text-danger"><strong>Warning:</strong> This action cannot be undone.</p>
                             <p>Are you sure you want to delete the following document(s)?</p>
                             <ul id="documentsToDeleteList" class="list-group mb-3">
                                 <!-- Documents will be listed here -->
                             </ul>
                         </div>
                         <div class="modal-footer">
                             <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                             <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">
                                 <i class="fas fa-trash"></i> Delete Documents
                             </button>
                         </div>
                     </div>
                 </div>
             </div>
             
             <!-- Bulk Replace Documents Confirmation Modal -->
             <div class="modal fade" id="bulkReplaceModal" tabindex="-1">
                 <div class="modal-dialog">
                     <div class="modal-content">
                         <div class="modal-header">
                             <h5 class="modal-title text-warning"><i class="fas fa-sync-alt"></i> Replace Documents</h5>
                             <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                         </div>
                         <div class="modal-body">
                             <p class="text-warning"><strong>Warning:</strong> This will replace the selected documents with new files.</p>
                             <p>Are you sure you want to replace the following document(s)?</p>
                             <ul id="documentsToReplaceList" class="list-group mb-3">
                                 <!-- Documents will be listed here -->
                             </ul>
                             <div class="alert alert-info">
                                 <i class="fas fa-info-circle"></i>
                                 <strong>Note:</strong> Please select exactly the same number of files to replace the selected documents.
                             </div>
                         </div>
                         <div class="modal-footer">
                             <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                             <button type="button" class="btn btn-warning" id="confirmBulkReplaceBtn">
                                 <i class="fas fa-sync-alt"></i> Replace Documents
                             </button>
                         </div>
                     </div>
                 </div>
             </div>
            <div class="input-area">
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-2 d-flex align-items-center">
                        <div class="dropdown w-100">
                            <button class="btn btn-outline-primary dropdown-toggle w-100" type="button" id="chatTopicsDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                All Topics
                            </button>
                            <ul class="dropdown-menu w-100" id="chatTopicsDropdownMenu" style="max-height: 300px; overflow-y: auto;"></ul>
                        </div>
                    </div>
                    <div class="col-md-7 d-flex">
                        <input type="text" class="form-control flex-grow-1" id="questionInput" placeholder="Ask your compliance question..." disabled>
                        <button class="btn btn-custom ms-2" id="askButton" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="row justify-content-center mb-2">
                    <div class="col-md-2 d-flex justify-content-center">
                        <button class="btn btn-outline-secondary w-100" id="exportBtn">
                            <i class="fas fa-download"></i> Export Chat
                        </button>
                    </div>
                    <!-- <div class="col-md-2 d-flex justify-content-center">
                        <button class="btn btn-outline-warning w-100" id="checkDocsBtn" disabled>
                            <i class="fas fa-search"></i> Check Documents
                        </button>
                    </div> -->
                    <div class="col-md-2 d-flex justify-content-center">
                        <button class="btn btn-outline-info w-100" id="batchQnAButton" disabled>
    <i class="fas fa-question-circle"></i> Upload Questionnaire (No Topics)
</button>
                    </div>
                    <div class="col-md-2 d-flex justify-content-center">
                        <button class="btn btn-outline-danger w-100" id="clearHistoryBtn">
                            <i class="fas fa-trash"></i> Clear History
                        </button>
                    </div>
                </div>
                <!-- Remove uploadPanel div if not used elsewhere -->
                <!-- Batch Q&A Upload Panel -->
<div id="batchQnAPanel" class="hidden mt-3 p-3 border rounded">
    <h5><i class="fas fa-question-circle"></i> Upload Questionnaire</h5>
                    <div class="file-upload-area" onclick="document.getElementById('batchQnAInput').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                        <h5>Click to select a file of questions</h5>
                        <p class="text-muted">Supported formats: PDF, DOCX, TXT, CSV, XML</p>
                        <input type="file" id="batchQnAInput" accept=".pdf,.docx,.txt,.csv,.xml" style="display: none;">
                    </div>
                    <div id="batchQnAFileName" class="mt-2"></div>
                    <button class="btn btn-primary mt-2" id="batchQnAUploadBtn" disabled>Upload & Get Answers</button>
                    <button class="btn btn-secondary mt-2 ms-2" id="cancelBatchQnABtn">Cancel</button>
                </div>
                <!-- Loading Spinner -->
                <div id="batchQnALoading" class="loading-overlay" style="display:none;">
                    <div class="loading-content">
                        <div class="spinner"></div>
                        <div>ü§ñ AI is thinking...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="loginSubmitBtn">Login</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="registerUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="registerSubmitBtn">Register</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Animation -->
    <!-- <div id="uploadAnimation" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%, -50%); z-index:2000; pointer-events:none;">
      <div class="upload-anim">
        <span class="file-icon">üìÑ</span>
        <span class="file-icon">üìã</span>
        <span class="file-icon">üìù</span>
        <span class="folder-icon">üìÅ</span>
      </div>
    </div> -->
    <!-- Delete Animation -->
    <!-- <div id="deleteAnimation" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%, -50%); z-index:2000; pointer-events:none;">
      <div class="delete-anim">
        <span class="folder-icon">üìÅ</span>
        <span class="file-icon">üìÑ</span>
        <span class="file-icon">üìã</span>
        <span class="file-icon">üìù</span>
        <span class="trash-icon">üóëÔ∏è</span>
      </div>
    </div> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
let aiInitialized = false;
        const UPLOAD_PIN = "1964"; // PIN from config_details.py
        let uploadPinCache = null;
        let uploadButtonUnlocked = false; // Track if upload button is unlocked
        let wrongPinAttempts = 0; // Track wrong PIN attempts
        const MAX_PIN_ATTEMPTS = 3; // Maximum allowed wrong attempts
let pendingAnimationStop = null;

window.addEventListener('DOMContentLoaded', function() {
    updateStatus('connecting'); // Show connecting status immediately
    initializeAI();
    setupEventListeners();
    // Add event delegation for sort-arrow clicks
    const docsTableThead = document.querySelector('.table thead');
    if (docsTableThead) {
        docsTableThead.addEventListener('click', function(e) {
            const arrow = e.target.closest('.sort-arrow');
            if (!arrow) return;
            const col = arrow.getAttribute('data-col');
            if (!col) return;
            // If the click is on the superscript (number), show popup
            if (e.target.tagName === 'SUP') {
                const idx = sortLevels.findIndex(s => s.column === col);
                showSortOrderPopup(arrow, col, idx);
                return;
            }
            // Otherwise, make this the main sorter
            const idx = sortLevels.findIndex(s => s.column === col);
            if (idx === -1) {
                sortLevels.unshift({ column: col, direction: 'desc' });
            } else if (idx === 0) {
                // Cycle direction or remove
                if (sortLevels[0].direction === 'desc') {
                    sortLevels[0].direction = 'asc';
                } else if (sortLevels[0].direction === 'asc') {
                    // Third press: remove from sortLevels
                    sortLevels.splice(0, 1);
                    if (sortLevels.length === 0) {
                        sortLevels = [{ column: 'topics', direction: 'asc' }];
                    }
                }
            } else {
                // Move to main sorter, keep direction
                const [item] = sortLevels.splice(idx, 1);
                sortLevels.unshift(item);
            }
            renderDocsTable();
            updateSortArrows();
        });
    }
    // Populate chat topics dropdown (Bootstrap style)
    fetch('/get_topics')
        .then(res => res.json())
        .then(data => {
            const menu = document.getElementById('chatTopicsDropdownMenu');
            const btn = document.getElementById('chatTopicsDropdownBtn');
            if (!menu || !btn) return;
            menu.innerHTML = '';
            // No Topics option (checkbox)
            const noneLi = document.createElement('li');
            noneLi.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" value="none" id="chatTopic_none"><label class="form-check-label" for="chatTopic_none">No Topics</label></div>`;
            menu.appendChild(noneLi);
            // All Topics option (checkbox)
            const allLi = document.createElement('li');
            allLi.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" value="all" id="chatTopic_all"><label class="form-check-label" for="chatTopic_all">All Topics</label></div>`;
            menu.appendChild(allLi);
            // Other topics (checkboxes)
            (data.topics || []).forEach(topic => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" value="${topic.id}" id="chatTopic_${topic.id}"><label class="form-check-label" for="chatTopic_${topic.id}">${topic.name}</label></div>`;
                menu.appendChild(li);
            });
            // Selection logic
            function updateBtnLabel() {
                const checked = menu.querySelectorAll('.form-check-input:checked');
                if (checked.length === 0 || (checked.length === 1 && checked[0].value === 'none')) {
                    btn.textContent = 'No Topics';
                } else if (checked.length > 0 && Array.from(checked).some(cb => cb.value === 'all')) {
                    btn.textContent = 'All Topics';
                } else {
                    const names = Array.from(checked).filter(cb => cb.value !== 'all' && cb.value !== 'none').map(cb => menu.querySelector(`label[for=\"chatTopic_${cb.value}\"]`).textContent);
                    btn.textContent = names.length > 0 ? names.join(', ') : 'No Topics';
                }
            }
            menu.addEventListener('change', function(e) {
                if (!e.target.classList.contains('form-check-input')) return;
                if (e.target.value === 'all' && e.target.checked) {
                    // Check all topic checkboxes except 'none'
                    menu.querySelectorAll('.form-check-input').forEach(cb => {
                        if (cb.value !== 'none') cb.checked = true;
                        if (cb.value === 'none') cb.checked = false;
                    });
                } else if (e.target.value === 'none' && e.target.checked) {
                    // Uncheck all others
                    menu.querySelectorAll('.form-check-input').forEach(cb => {
                        if (cb.value !== 'none') cb.checked = false;
                    });
                } else {
                    // If any topic or 'all' is checked, uncheck 'none'
                    if (e.target.checked) {
                        menu.querySelector('.form-check-input[value="none"]').checked = false;
                    }
                    // If all topics (not 'all' or 'none') are checked, check 'all'
                    const topicCheckboxes = Array.from(menu.querySelectorAll('.form-check-input')).filter(cb => cb.value !== 'all' && cb.value !== 'none');
                    const allChecked = topicCheckboxes.every(cb => cb.checked);
                    menu.querySelector('.form-check-input[value="all"]').checked = allChecked;
                    // If not all topics are checked, uncheck 'all'
                    if (!allChecked) {
                        menu.querySelector('.form-check-input[value="all"]').checked = false;
                    }
                }
                updateBtnLabel();
                // Also update the Upload Questionnaire button
                updateUploadQuestionnaireButton();
            });
            // Set initial state: No Topics checked
            menu.querySelector('.form-check-input[value="none"]').checked = true;
            updateBtnLabel();
            // Update the Upload Questionnaire button initially
            updateUploadQuestionnaireButton();
            attachChatTopicsDropdownHandler && attachChatTopicsDropdownHandler();
        });
    // On DOMContentLoaded, also enforce chat bar state
    document.addEventListener('DOMContentLoaded', function() {
        const menu = document.getElementById('chatTopicsDropdownMenu');
        if (menu) {
            const checked = menu.querySelectorAll('.form-check-input:checked');
            setChatBarEnabled(!(checked.length === 0 || checked[0].value === 'all'));
        }
    });
    // --- Per-topic-selection chat session logic ---
    function getChatSessionKey(selectedTopics) {
        if (!selectedTopics || selectedTopics.length === 0 || selectedTopics.includes('all')) {
            return 'topics:all';
        }
        // Always sort for consistency
        const sorted = [...selectedTopics].sort();
        return 'topics:' + sorted.join(',');
    }

    let currentChatSessionKey = 'topics:all';
    let chatHistories = {}; // sessionKey -> array of {question, answer}

    function displayChatHistory(sessionKey) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        // Show the initial AI welcome message with topic name(s)
        const menu = document.getElementById('chatTopicsDropdownMenu');
        let topicLabel = 'All Topics';
        let isAllTopics = true;
        if (menu) {
            const checked = menu.querySelectorAll('.form-check-input:checked');
            if (checked.length === 0 || checked[0].value === 'all') {
                topicLabel = 'All Topics';
                isAllTopics = true;
            } else {
                const names = Array.from(checked).map(c => menu.querySelector(`label[for="chatTopic_${c.value}"]`).textContent);
                topicLabel = names.join(', ');
                isAllTopics = false;
            }
        }
        // System message: prompt to select topics if none selected
        if (isAllTopics) {
            addMessage(`ü§ñ AI Assistant: <b>Welcome!</b> Please <b>select your topic(s)</b> to get started. The chat bar will be enabled once you choose at least one topic.`, 'ai');
        } else {
            addMessage(`ü§ñ AI Assistant: Welcome! I'm your DP AI Assistant. <br><b>Current Topic(s):</b> ${topicLabel}<br>Please upload compliance documents or ask a question to get started.`, 'ai');
        }
        const history = chatHistories[sessionKey] || [];
        history.forEach(item => {
            addMessage('üßë You: ' + item.question, 'user');
            
            // Format answer with confidence and sources if available
            //let answerText = `ü§ñ <strong>AI:</strong> ${item.answer}`;
            //if (item.confidence && item.confidence !== 'N/A' && item.confidence !== 0) {
              //  answerText += `<br><strong>Confidence:</strong> ${item.confidence}%`;
            //}
            if (item.sources && item.sources !== 'N/A' && item.sources !== 'Error occurred') {
                answerText += `<br><strong>Sources:</strong> ${item.sources}`;
            }
            addMessage(answerText, 'ai');
        });
        // Do not call setChatBarEnabled here; chat bar enable/disable is handled by setChatBarAndBatchQnAEnabled only
    }

    function setChatBarEnabled(enabled) {
        const questionInput = document.getElementById('questionInput');
        const askButton = document.getElementById('askButton');
        if (enabled) {
            questionInput.disabled = false;
            questionInput.readOnly = false;
            askButton.disabled = false;
            questionInput.classList.remove('disabled-chat-input');
            askButton.classList.remove('disabled-chat-input');
            questionInput.removeAttribute('title');
            askButton.removeAttribute('title');
        } else {
            questionInput.disabled = true;
            questionInput.readOnly = true;
            askButton.disabled = true;
            questionInput.classList.add('disabled-chat-input');
            askButton.classList.add('disabled-chat-input');
            questionInput.setAttribute('title', 'Choose a topic');
            askButton.setAttribute('title', 'Choose a topic');
        }
    }

    function fetchChatHistory(sessionKey) {
        fetch(`/get_history?session_key=${encodeURIComponent(sessionKey)}`)
            .then(res => res.json())
            .then(data => {
                chatHistories[sessionKey] = data.history || [];
                displayChatHistory(sessionKey);
            });
    }

    function attachChatTopicsDropdownHandler() {
        const menu = document.getElementById('chatTopicsDropdownMenu');
        if (menu) {
            menu.addEventListener('change', function() {
                const selected = Array.from(menu.querySelectorAll('.form-check-input:checked')).map(cb => cb.value);
                currentChatSessionKey = getChatSessionKey(selected);
                if (chatHistories[currentChatSessionKey]) {
                    displayChatHistory(currentChatSessionKey);
                } else {
                    fetchChatHistory(currentChatSessionKey);
                }
                // Also update the Upload Questionnaire button
                updateUploadQuestionnaireButton();
            });
        }
    }
});

function updateStatus(state) {
    const indicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    if (indicator && statusText) {
        indicator.style.background = ''; // Always clear inline style first
        if (state === true || state === 'connected') {
            indicator.className = 'status-indicator status-connected';
            statusText.textContent = 'Connected';
        } else if (state === 'connecting') {
            indicator.className = 'status-indicator';
            indicator.style.background = '#ffc107'; // yellow
            statusText.textContent = 'Connecting...';
        } else {
            indicator.className = 'status-indicator status-disconnected';
            statusText.textContent = 'Disconnected';
        }
    }
}

function initializeAI() {
    console.log('Starting AI initialization...');
    fetch('/init_ai', { method: 'POST' })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('AI initialization response:', data);
        if (data.status === 'success' && data.ready) {
            aiInitialized = true;
            updateStatus(true);
            const questionInput = document.getElementById('questionInput');
            const askButton = document.getElementById('askButton');
            
            if (questionInput) questionInput.disabled = false;
            if (askButton) askButton.disabled = false;
            console.log('AI initialized successfully');
        } else if (data.status === 'initializing') {
            updateStatus('connecting');
            addLogMessage('üîÑ AI Assistant is initializing in background...');
            // Poll for status every 2 seconds
            setTimeout(checkAIStatus, 2000);
        } else {
            updateStatus(false);
            addLogMessage('‚ùå Failed to initialize AI Assistant: ' + (data.error || 'Unknown error'));
            console.log('AI initialization failed:', data.error);
        }
    })
    .catch(error => {
        updateStatus(false);
        addLogMessage('‚ùå Error initializing AI: ' + error);
        console.log('AI initialization error:', error);
    });
}

function checkAIStatus() {
    fetch('/document_status')
    .then(response => response.json())
    .then(data => {
        if (data.ready) {
            aiInitialized = true;
            updateStatus(true);
            const questionInput = document.getElementById('questionInput');
            const askButton = document.getElementById('askButton');
            
            if (questionInput) questionInput.disabled = false;
            if (askButton) askButton.disabled = false;
            addLogMessage('‚úÖ AI Assistant is ready!');
            console.log('AI is ready');
        } else if (data.status === 'initializing') {
            updateStatus('connecting');
            addLogMessage('üîÑ AI Assistant is still initializing...');
            setTimeout(checkAIStatus, 2000);
        } else {
            updateStatus(false);
            addLogMessage('‚ùå AI Assistant initialization failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        addLogMessage('‚ùå Error checking AI status: ' + error);
    });
}

function setupEventListeners() {
    // Chat/Logs/Docs tab toggle
    const chatTabBtn = document.getElementById('chatTabBtn');
    const logsTabBtn = document.getElementById('logsTabBtn');
    const docsTabBtn = document.getElementById('docsTabBtn');
    
    if (chatTabBtn && logsTabBtn && docsTabBtn) {
        chatTabBtn.addEventListener('click', function() {
            document.getElementById('chatMessages').classList.remove('hidden');
            document.getElementById('logsArea').classList.add('hidden');
            document.getElementById('docsArea').classList.add('hidden');
            document.querySelector('.input-area').classList.remove('hidden');
            chatTabBtn.classList.add('active');
            logsTabBtn.classList.remove('active');
            docsTabBtn.classList.remove('active');
        });
        
        logsTabBtn.addEventListener('click', function() {
            document.getElementById('chatMessages').classList.add('hidden');
            document.getElementById('logsArea').classList.remove('hidden');
            document.getElementById('docsArea').classList.add('hidden');
            document.querySelector('.input-area').classList.remove('hidden');
            chatTabBtn.classList.remove('active');
            logsTabBtn.classList.add('active');
            docsTabBtn.classList.remove('active');
        });
        
        docsTabBtn.addEventListener('click', function() {
            document.getElementById('chatMessages').classList.add('hidden');
            document.getElementById('logsArea').classList.add('hidden');
            document.getElementById('docsArea').classList.remove('hidden');
            document.querySelector('.input-area').classList.add('hidden');
            chatTabBtn.classList.remove('active');
            logsTabBtn.classList.remove('active');
            docsTabBtn.classList.add('active');
        });
        
        // Hide input area when logs tab is active
        logsTabBtn.addEventListener('click', function() {
            document.querySelector('.input-area').classList.add('hidden');
        });
        
        // Show input area when chat tab is active
        chatTabBtn.addEventListener('click', function() {
            document.querySelector('.input-area').classList.remove('hidden');
        });
    }
    
    // Add null checks for all DOM elements
    const uploadButton = document.getElementById('uploadButton');
    const uploadPanel = document.getElementById('uploadPanel');
    const batchQnAButton = document.getElementById('batchQnAButton');
    const batchQnAPanel = document.getElementById('batchQnAPanel');
    const cancelBatchQnABtn = document.getElementById('cancelBatchQnABtn');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    
    // Only add event listeners if elements exist
    if (uploadButton && uploadPanel) {
        uploadButton.addEventListener('click', function() {
            uploadPanel.classList.remove('hidden');
            if (batchQnAPanel) batchQnAPanel.classList.add('hidden');
        });
    }
    
    if (batchQnAButton && batchQnAPanel) {
        batchQnAButton.addEventListener('click', function() {
            batchQnAPanel.classList.remove('hidden');
            if (uploadPanel) uploadPanel.classList.add('hidden');
        });
    }
    
    if (cancelUploadBtn && uploadPanel) {
        cancelUploadBtn.addEventListener('click', function() {
            uploadPanel.classList.add('hidden');
        });
    }
    
    if (cancelBatchQnABtn && batchQnAPanel) {
        cancelBatchQnABtn.addEventListener('click', function() {
            batchQnAPanel.classList.add('hidden');
        });
    }
    
    // Add event listeners for batch Q&A file upload
    const batchQnAInput = document.getElementById('batchQnAInput');
    const batchQnAUploadBtn = document.getElementById('batchQnAUploadBtn');
    const batchQnAFileName = document.getElementById('batchQnAFileName');
    
    if (batchQnAInput) {
        batchQnAInput.addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const fileName = files[0].name;
                batchQnAFileName.textContent = `Selected: ${fileName}`;
                batchQnAFileName.style.color = '#28a745';
                batchQnAUploadBtn.disabled = false;
            } else {
                batchQnAFileName.textContent = '';
                batchQnAUploadBtn.disabled = true;
            }
        });
    }
    
    if (batchQnAUploadBtn) {
        batchQnAUploadBtn.addEventListener('click', function() {
            const files = batchQnAInput.files;
            if (files.length === 0) {
                alert('Please select a file first.');
                return;
            }
            
            // Show loading spinner
            const loadingSpinner = document.getElementById('batchQnALoading');
            if (loadingSpinner) loadingSpinner.style.display = 'flex';
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('file', files[0]);
            
            // Upload file and get answers
            fetch('/upload_questions', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    // Start progress monitoring
                    const jobId = data.job_id || 'unknown';
                    monitorQuestionnaireProgress(jobId);
                    
                    // Show initial status
                    addLogMessage(`üìä Questionnaire uploaded: ${data.questions ? data.questions.length : 0} questions found`);
                    addLogMessage(`üîÑ Processing started - monitoring progress...`);
                }
            })
            .catch(error => {
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                alert('Error uploading file: ' + error);
            });
        });
    }
}

function showInitPanel() {
    document.getElementById('initPanel').classList.remove('hidden');
    document.getElementById('uploadPanel').classList.add('hidden');
}

function hideInitPanel() {
    document.getElementById('initPanel').classList.add('hidden');
}

function showUploadPanel() {
    if (uploadPinCache) {
        const panel = document.getElementById('uploadPanel');
        if (panel) panel.classList.remove('hidden');
        return;
    }
    const pin = prompt('Enter security PIN to upload documents:');
    if (pin === UPLOAD_PIN) {
        uploadPinCache = pin;
        const panel = document.getElementById('uploadPanel');
        if (panel) panel.classList.remove('hidden');
    } else {
        alert('Incorrect PIN. Access denied.');
    }
}

function hideUploadPanel() {
    const panel = document.getElementById('uploadPanel');
    if (panel) panel.classList.add('hidden');
}

function promptForPin() {
    if (uploadPinCache) {
        showUploadPanel();
        return;
    }
    const pin = prompt('Enter security PIN to upload documents:');
    if (pin !== null) {
        if (pin === '1964') { // Default PIN from config
            uploadPinCache = pin;
            showUploadPanel();
        } else {
            alert('Incorrect PIN. Access denied.');
        }
    }
}

function handleCheckerFileSelect() {
    const files = document.getElementById('checkerFileInput').files;
    if (files.length > 0) {
        addLogMessage('üìÑ Selected ' + files.length + ' question document(s)');
        processCheckerFiles();
    }
}

function processCheckerFiles() {
    const files = document.getElementById('checkerFileInput').files;
    if (files.length === 0) {
        alert('Please select files to process.');
        return;
    }

    addLogMessage('üîÑ Processing question documents...');
    
    // Show file names in chat
    let fileNames = [];
    for (let file of files) {
        fileNames.push(file.name);
    }
    addLogMessage('üìÑ Files selected: ' + fileNames.join(', '));
    
    // TODO: Implement question processing logic
    addMessage('ü§ñ AI: Question processing feature will be implemented soon.', 'ai');
}

function handleCheckerUpload() {
    // Open file picker for questionnaire upload
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf,.docx,.txt,.csv,.xml';
    input.multiple = true;
    input.onchange = function(e) {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            addLogMessage('üìÑ Questionnaire files selected: ' + files.map(f => f.name).join(', '));
            // TODO: Implement upload to backend if needed
        }
    };
    input.click();
}

// function checkDocumentStatus() {
//     if (!aiInitialized) return;
//     fetch('/document_status', { method: 'GET' })
//     .then(response => response.json())
//     .then(data => {
//         if (data.error) {
//             addLogMessage('‚ùå Error checking document status: ' + data.error);
//         } else {
//             addLogMessage(`üìä Document Status: ${data.document_count} documents, Database: ${data.database_loaded ? 'Loaded' : 'Not loaded'}`);
//             if (data.documents && data.documents.length > 0) {
//                 addLogMessage('üìÑ Uploaded documents: ' + data.documents.join(', '));
//             } else {
//                 addLogMessage('üìÑ No documents uploaded yet.');
//             }
//         }
//     })
//     .catch(error => {
//         addLogMessage('‚ùå Error checking document status: ' + error);
//     });
// }

function askQuestion() {
    const input = document.getElementById('questionInput');
    const question = input.value.trim();
    if (!question) return;
    addMessage('üßë You: ' + question, 'user');
    input.value = '';
    // Add thinking robot message
    const thinkingMessage = document.createElement('div');
    thinkingMessage.className = 'message ai-message';
    thinkingMessage.id = 'thinkingMessage';
    thinkingMessage.innerHTML = '<span style="font-size:2em">ü§ñ</span> <em>Thinking...</em>';
    document.getElementById('chatMessages').appendChild(thinkingMessage);
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: question })
    })
    .then(response => response.json())
    .then(data => {
        // Remove thinking message
        const thinkingMsg = document.getElementById('thinkingMessage');
        if (thinkingMsg) thinkingMsg.remove();
        
        if (data.error) {
            addMessage('‚ùå Error: ' + data.error, 'ai');
        } else {
            // Create the AI response container
            let aiResponse = 'ü§ñ <strong>AI:</strong> ';
            
            // Always show the helpful answer first
            aiResponse += '<span class="helpful-answer">' + data.answer + '</span>';
            
            // Always show the detailed answer toggle
            aiResponse += ' <span class="detailed-toggle" onclick="toggleDetailedAnswer(this)" data-detailed="' + (data.detailed_answer || '').replace(/"/g, '&quot;').replace(/\n/g, '<br>') + '">Detailed Answer ‚ñº</span>';
            
            // Add confidence if available
            if (data.confidence) {
                aiResponse += '<br><strong>Confidence:</strong> ' + data.confidence + '%';
            }
            
            // Add sources if available
            if (data.sources) {
                if (typeof data.sources === 'object' && data.sources.summary && data.sources.detailed) {
                    aiResponse += '<br><strong>Sources:</strong> <span class="source-summary">' + data.sources.summary + '</span> <span class="source-toggle" onclick="toggleSourceDetails(this)" data-detailed="' + data.sources.detailed.replace(/"/g, '&quot;') + '">‚ñº</span>';
                } else {
                    aiResponse += '<br><strong>Sources:</strong> ' + data.sources;
                }
            }
            
            addMessage(aiResponse, 'ai');
        }
    })
    .catch(error => {
        const thinkingMsg = document.getElementById('thinkingMessage');
        if (thinkingMsg) thinkingMsg.remove();
        addMessage('‚ùå Error: ' + error, 'ai');
    });
}

function uploadFiles() {
    const pin = uploadPinCache || document.getElementById('uploadPin').value;
    const files = document.getElementById('fileInput').files;
    if (!pin) {
        alert('Please enter the security PIN.');
        return;
    }
    if (files.length === 0) {
        alert('Please select files to upload.');
        return;
    }
    const formData = new FormData();
    formData.append('pin', pin);
    for (let file of files) {
        formData.append('files', file);
    }
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            addMessage('üìö Documents uploaded: ' + data.files.join(', '), 'ai');
            addLogMessage('üìö Documents uploaded successfully: ' + data.files.join(', '));
            addLogMessage('üíæ Documents are now permanently stored and will be available in future sessions');
            hideUploadPanel();
            // Clear file input and file list
            document.getElementById('fileInput').value = '';
            document.getElementById('fileList').innerHTML = '';
        } else {
            alert('Error: ' + data.error);
            addLogMessage('‚ùå Upload failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error uploading files: ' + error);
        addLogMessage('‚ùå Error uploading files: ' + error);
    });
}

function toggleMode() {
    if (!aiInitialized) {
        alert('Please initialize the AI Assistant first.');
        return;
    }

    showLoading('Switching modes...');

    fetch('/toggle_mode', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            currentMode = data.mode;
            document.getElementById('modeIndicator').textContent = 'Mode: ' + currentMode;
            addLogMessage('üîÑ Switched to ' + currentMode + ' mode.');
            
            // Update interface based on mode
            if (currentMode === 'Checker') {
                document.getElementById('questionInput').placeholder = 'Ask questions or use upload button...';
                document.getElementById('questionInput').disabled = false;
                document.getElementById('askButton').disabled = false;
                document.getElementById('checkerUploadBtn').disabled = false;
                addLogMessage('üîÑ Switched to Checker mode');
            } else {
                document.getElementById('questionInput').placeholder = 'Ask your compliance question...';
                document.getElementById('questionInput').disabled = false;
                document.getElementById('askButton').disabled = false;
                document.getElementById('checkerUploadBtn').disabled = true;
                addLogMessage('üîÑ Switched to Q&A mode');
            }
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        hideLoading();
        alert('Error toggling mode: ' + error);
    });
}

function exportChat() {
    const chatContent = document.getElementById('chatMessages').innerText;
    
    showLoading('Exporting chat...');

    fetch('/export_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_content: chatContent
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            addMessage('üíæ ' + data.message, 'ai');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        hideLoading();
        alert('Error exporting chat: ' + error);
    });
}

function handleFileSelect() {
    const files = document.getElementById('fileInput').files;
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';

    for (let file of files) {
        const fileItem = document.createElement('div');
        fileItem.className = 'alert alert-info';
        fileItem.innerHTML = `<i class="fas fa-file"></i> ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        fileList.appendChild(fileItem);
    }
}

function addMessage(text, type) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    messageDiv.innerHTML = text;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addLogMessage(text, id = null) {
    const logsArea = document.getElementById('logsArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai-message';
    if (id) {
        messageDiv.id = id;
    }
    const timestamp = new Date().toLocaleTimeString();
    messageDiv.innerHTML = `<strong>üìã</strong> [${timestamp}] ${text}`;
    logsArea.appendChild(messageDiv);
    logsArea.scrollTop = logsArea.scrollHeight;
    return messageDiv;
}

function updateLogMessage(id, text) {
    const messageDiv = document.getElementById(id);
    if (messageDiv) {
        const timestamp = new Date().toLocaleTimeString();
        messageDiv.innerHTML = `<strong>üìã</strong> [${timestamp}] ${text}`;
    }
}

function showLoading(text) {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// User authentication logic
const loginBtn = document.getElementById('loginBtn2');
const registerBtn = document.getElementById('registerBtn2');
const logoutBtn = document.getElementById('logoutBtn2');
const userStatusText = document.getElementById('userStatusText2');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');

// Check user status on page load
function checkUserStatus() {
    fetch('/user_status')
    .then(response => response.json())
    .then(data => {
        if (data.logged_in) {
            userStatusText.textContent = `Welcome, ${data.username}!`;
            loginBtn.classList.add('hidden');
            registerBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            window.isLoggedInUser = true;  // Set flag for logged-in user
        } else {
            userStatusText.textContent = 'Guest User';
            loginBtn.classList.remove('hidden');
            registerBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            window.isLoggedInUser = false;  // Set flag for guest user
        }
    });
}

// Login functionality
loginBtn.addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('loginModal'));
    modal.show();
});

document.getElementById('loginSubmitBtn').addEventListener('click', function() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    fetch('/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, password})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            if (modal) modal.hide();
            
            // Clear any existing guest session data before checking user status
            if (!window.isLoggedInUser) {
                fetch('/clear_guest_session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                }).catch(error => {
                    console.log('Could not clear guest session:', error);
                });
            }
            
            checkUserStatus();
            // Fetch and display chat history
            fetch('/get_history')
                .then(response => response.json())
                .then(data => {
                    // Clear chat window
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    // Display each message in order (oldest to newest)
                    (data.history || []).reverse().forEach(item => {
                        addMessage('üßë You: ' + item.question, 'user');
                        
                        // Format answer with confidence and sources if available
                        let answerText = `ü§ñ <strong>AI:</strong> ${item.answer}`;
                        if (item.confidence && item.confidence !== 'N/A' && item.confidence !== 0) {
                            answerText += `<br><strong>Confidence:</strong> ${item.confidence}%`;
                        }
                        if (item.sources && item.sources !== 'N/A' && item.sources !== 'Error occurred') {
                            answerText += `<br><strong>Sources:</strong> ${item.sources}`;
                        }
                        addMessage(answerText, 'ai');
                    });
                });
        } else {
            alert(data.error || 'Login failed');
        }
    });
});

// Register functionality
registerBtn.addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('registerModal'));
    modal.show();
});

document.getElementById('registerSubmitBtn').addEventListener('click', function() {
    const username = document.getElementById('registerUsername').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    
    fetch('/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, email, password})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
            
            // Clear any existing guest session data before checking user status
            if (!window.isLoggedInUser) {
                fetch('/clear_guest_session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                }).catch(error => {
                    console.log('Could not clear guest session:', error);
                });
            }
            
            checkUserStatus();
            alert('Registration successful!');
        } else {
            alert('Registration failed: ' + data.error);
        }
    });
});

// Logout functionality
logoutBtn.addEventListener('click', function() {
    fetch('/logout', {method: 'POST'})
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            checkUserStatus();
            alert('Logout successful!');
        }
    });
});

// Clear history functionality
clearHistoryBtn.addEventListener('click', function() {
    if (confirm('Are you sure you want to clear your chat history? This cannot be undone.')) {
        fetch('/clear_history', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Chat history cleared!');
            }
        });
    }
});

// Export history functionality
document.getElementById('exportBtn').addEventListener('click', function() {
    fetch('/export_history', {method: 'POST'})
    .then(response => {
        if (!response.ok) throw new Error('Failed to export history');
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'chat_history.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    })
    .catch(err => {
        alert('Error exporting history: ' + err.message);
    });
});

// --- Document Management UI Logic ---
const addDocBtn = document.getElementById('addDocBtn');
const addDocInput = document.getElementById('addDocInput');
const docsTableBody = document.getElementById('docsTableBody');
const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
const bulkReplaceBtn = document.getElementById('bulkReplaceBtn');
const bulkReplaceInput = document.getElementById('bulkReplaceInput');
const selectAllCheckbox = document.getElementById('selectAllCheckbox');

let docsList = [];
// Multi-level sort state
let sortLevels = [{ column: 'topics', direction: 'asc' }];
const sortableColumns = ['topics', 'name', 'type', 'uploaded'];

function renderDocsTableHeader() {
    const thead = document.querySelector('#docsTableBody').parentElement.querySelector('thead');
    if (!thead) return;
    const headerRow = thead.querySelector('tr');
    if (!headerRow) return;
    const columns = [
        { key: 'select', label: '' },
        { key: 'name', label: 'Name' },
        { key: 'topics', label: 'Tags' },
        { key: 'type', label: 'Type' },
        { key: 'uploaded', label: 'Uploaded' },
        { key: 'actions', label: 'Actions' }
    ];
    headerRow.innerHTML = '';
    columns.forEach(col => {
        let th = document.createElement('th');
        th.style.width = col.key === 'select' ? '50px' : (col.key === 'actions' ? '120px' : '');
        if (sortableColumns.includes(col.key)) {
            // Find sort level for this column
            const sortIdx = sortLevels.findIndex(s => s.column === col.key);
            let arrow = '';
            if (sortIdx !== -1) {
                arrow = `<span class="sort-arrow" data-col="${col.key}" data-level="${sortIdx+1}" style="cursor:pointer;">${sortLevels[sortIdx].direction === 'asc' ? '‚ñ≤' : '‚ñº'}<sup>${sortIdx+1}</sup></span>`;
            } else {
                arrow = `<span class="sort-arrow" data-col="${col.key}" style="opacity:0.3;cursor:pointer;">‚ñ≤</span>`;
            }
            th.innerHTML = `${col.label} ${arrow}`;
        } else {
            th.textContent = col.label;
        }
        headerRow.appendChild(th);
    });
    // Add event listeners for sorting only to the arrows
    headerRow.querySelectorAll('.sort-arrow').forEach(arrow => {
        let hoverTimeout = null;
        arrow.addEventListener('mouseenter', function() {
            hoverTimeout = setTimeout(() => {
                const col = this.getAttribute('data-col');
                const idx = sortLevels.findIndex(s => s.column === col);
                if (idx !== -1) {
                    // Duplicate the arrow n times for nth order
                    this.innerHTML = `${sortLevels[idx].direction === 'asc' ? '‚ñ≤' : '‚ñº'}<sup>${idx+1}</sup>`.repeat(idx+1);
                }
            }, 2000);
        });
        arrow.addEventListener('mouseleave', function() {
            clearTimeout(hoverTimeout);
            renderDocsTableHeader();
        });
        arrow.addEventListener('click', function(e) {
            const col = this.getAttribute('data-col');
            const idx = sortLevels.findIndex(s => s.column === col);
            if (idx !== -1) {
                // Toggle direction if not shift, or move to last if shift
                if (e.shiftKey) {
                    const [item] = sortLevels.splice(idx, 1);
                    sortLevels.push(item);
                } else {
                    sortLevels[idx].direction = sortLevels[idx].direction === 'asc' ? 'desc' : 'asc';
                }
            } else {
                sortLevels.push({ column: col, direction: 'asc' });
            }
            renderDocsTableHeader();
            loadDocuments();
        });
    });
}

function renderDocsTable() {
    docsTableBody.innerHTML = '';
    if (docsList.length === 0) {
        docsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No documents uploaded yet.</td></tr>';
        return;
    }
    // Sort docsList according to sortLevels
    docsList.sort((a, b) => {
        for (let { column, direction } of sortLevels) {
            let av = a[column], bv = b[column];
            // For topics, compare as comma-joined string
            if (column === 'topics') {
                av = (a.tags || []).join(',');
                bv = (b.tags || []).join(',');
            }
            // For name, compare lower-case
            if (column === 'name') {
                av = av ? av.toLowerCase() : '';
                bv = bv ? bv.toLowerCase() : '';
            }
            if (av < bv) return direction === 'asc' ? -1 : 1;
            if (av > bv) return direction === 'asc' ? 1 : -1;
        }
        return 0;
    });
    docsList.forEach(doc => {
        const tr = document.createElement('tr');
        const fileSize = (doc.size / 1024).toFixed(1) + ' KB';
        const tags = doc.tags || [];
        const tagsHtml = tags.length > 0 ? 
            tags.map(tag => `<span class="badge bg-primary me-1">${tag}</span>`).join('') : 
            '<span class="text-muted">No tags</span>';
        tr.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input doc-checkbox" value="${doc.name}">
            </td>
            <td>${doc.name}</td>
            <td>${tagsHtml}</td>
            <td>${doc.type}</td>
            <td>${doc.uploaded}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary rename-doc-btn" data-filename="${doc.name}" title="Rename">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
        docsTableBody.appendChild(tr);
    });
    
    // Add event listeners to checkboxes
    const checkboxes = document.querySelectorAll('.doc-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkButtons);
    });
    
    // Add event listeners to rename buttons
    const renameButtons = document.querySelectorAll('.rename-doc-btn');
    renameButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filename = this.getAttribute('data-filename');
            showRenameModal(filename);
        });
    });
    if (pendingAnimationStop) { setTimeout(pendingAnimationStop, 1500); pendingAnimationStop = null; }
}

function updateBulkButtons() {
    const selectedCheckboxes = document.querySelectorAll('.doc-checkbox:checked');
    const hasSelection = selectedCheckboxes.length > 0;
    
    bulkDeleteBtn.disabled = !hasSelection;
    bulkReplaceBtn.disabled = !hasSelection;
    
    // Update select all checkbox
    const allCheckboxes = document.querySelectorAll('.doc-checkbox');
    const allChecked = allCheckboxes.length > 0 && allCheckboxes.length === selectedCheckboxes.length;
    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < allCheckboxes.length;
}

function getSelectedDocuments() {
    const selectedCheckboxes = document.querySelectorAll('.doc-checkbox:checked');
    return Array.from(selectedCheckboxes).map(cb => cb.value);
}

function loadDocuments() {
    const cacheBuster = Date.now();
    // Get selected topics from Docs Management dropdown
    let selectedTopics = [];
    const topicDropdownMenu = document.getElementById('topicDropdownMenu');
    if (topicDropdownMenu) {
        selectedTopics = Array.from(topicDropdownMenu.querySelectorAll('.topic-checkbox:checked')).map(cb => cb.value);
    }
    let topic = 'all';
    let selected_topics_param = '';
    if (selectedTopics.length === 1 && selectedTopics[0] !== 'all') {
        topic = selectedTopics[0];
    } else if (selectedTopics.length > 1) {
        topic = 'multiple';
        // Always send sorted array of integers
        const sortedInts = selectedTopics.filter(v => v !== 'all').map(v => parseInt(v, 10)).sort((a, b) => a - b);
        selected_topics_param = `&selected_topics=${JSON.stringify(sortedInts)}`;
    }
    let url = `/get_documents?cb=${cacheBuster}&topic=${topic}${selected_topics_param}`;
    // Send sortLevels as a query param
    if (sortLevels.length > 0) {
        const sortParam = sortLevels.map(s => `${s.column}:${s.direction}`).join(',');
        url += `&sort=${encodeURIComponent(sortParam)}`;
    }
    docsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading documents...</td></tr>';
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.documents) {
                docsList = data.documents;
                renderDocsTableHeader();
                renderDocsTable();
                updateBulkButtons();
            } else {
                docsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Error loading documents</td></tr>';
            }
        })
        .catch(error => {
            docsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Error loading documents</td></tr>';
        });
}

// Select all checkbox functionality
selectAllCheckbox.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.doc-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
    updateBulkButtons();
});

// Bulk delete functionality
bulkDeleteBtn.addEventListener('click', function() {
    const selectedDocs = getSelectedDocuments();
    if (selectedDocs.length === 0) {
        addLogMessage('‚ö†Ô∏è Please select documents to delete.');
        return;
    }
    
    // Show custom confirmation modal
    const documentsList = document.getElementById('documentsToDeleteList');
    documentsList.innerHTML = '';
    
    selectedDocs.forEach(docName => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerHTML = `<i class="fas fa-file text-primary"></i> ${docName}`;
        documentsList.appendChild(li);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    modal.show();
});

// Bulk replace functionality
bulkReplaceBtn.addEventListener('click', function() {
    const selectedDocs = getSelectedDocuments();
    if (selectedDocs.length === 0) {
        addLogMessage('‚ö†Ô∏è Please select documents to replace.');
        return;
    }
    
    // Show custom confirmation modal
    const documentsList = document.getElementById('documentsToReplaceList');
    documentsList.innerHTML = '';
    
    selectedDocs.forEach(docName => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerHTML = `<i class="fas fa-file text-primary"></i> ${docName}`;
        documentsList.appendChild(li);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('bulkReplaceModal'));
    modal.show();
});

bulkReplaceInput.addEventListener('change', function(e) {
    const selectedDocs = getSelectedDocuments();
    const files = e.target.files;
    
    if (files.length === 0) {
        addLogMessage('‚ö†Ô∏è Please select a file to replace with.');
        return;
    }
    
    if (files.length !== selectedDocs.length) {
        addLogMessage(`‚ö†Ô∏è Please select exactly ${selectedDocs.length} file${selectedDocs.length > 1 ? 's' : ''} to replace the selected documents.`);
        return;
    }
    
    // Replace documents one by one
    let replacedCount = 0;
    let errorCount = 0;
    addLogMessage(`üîÑ Starting replacement of ${selectedDocs.length} document${selectedDocs.length > 1 ? 's' : ''}...`);
    
    selectedDocs.forEach((docName, index) => {
        const formData = new FormData();
        formData.append('file', files[index]);
        formData.append('old_filename', docName);
        
        fetch('/replace_document', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                replacedCount++;
                addLogMessage(`üîÑ Successfully replaced: ${docName}`);
            } else if (data.status === 'conflict') {
                // Handle filename conflict
                showConflictModal(data.message, data.filename, data.old_filename);
                return; // Stop processing this file
            } else {
                errorCount++;
                console.error(`Error replacing ${docName}: ${data.error}`);
                addLogMessage(`‚ùå Error replacing ${docName}: ${data.error}`);
            }
            
            // Check if all replaces are complete
            if (replacedCount + errorCount === selectedDocs.length) {
                if (errorCount === 0) {
                    addLogMessage(`üîÑ Successfully replaced ${replacedCount} document${replacedCount > 1 ? 's' : ''}`);
                } else {
                    addLogMessage(`‚ö†Ô∏è Replaced ${replacedCount} document${replacedCount > 1 ? 's' : ''}, ${errorCount} failed`);
                }
                
                // Refresh the document list
                setTimeout(() => {
                    loadDocuments();
                }, 1000);
            }
        })
        .catch(error => {
            errorCount++;
            console.error(`Error replacing ${docName}:`, error);
            addLogMessage(`‚ùå Network error replacing ${docName}: ${error}`);
            
            if (replacedCount + errorCount === selectedDocs.length) {
                addLogMessage(`‚ö†Ô∏è Replaced ${replacedCount} document${replacedCount > 1 ? 's' : ''}, ${errorCount} failed`);
                setTimeout(() => {
                    loadDocuments();
                }, 1000);
            }
        });
    });
    
    bulkReplaceInput.value = '';
});

// Function to disconnect AI and lockout the web instance
function disconnectAndLockout() {
    // Disconnect AI
    aiInitialized = false;
    
    // Clear any ongoing operations
    if (pendingAnimationStop) {
        clearTimeout(pendingAnimationStop);
    }
    
    // Disable all interactive elements
    const interactiveElements = document.querySelectorAll('button, input, textarea, select');
    interactiveElements.forEach(element => {
        element.disabled = true;
    });
    
    // Show lockout message
    const chatArea = document.getElementById('chatMessages');
    if (chatArea) {
        const lockoutMessage = document.createElement('div');
        lockoutMessage.className = 'message ai-message';
        lockoutMessage.innerHTML = '<strong>üîí SYSTEM LOCKOUT:</strong> Maximum PIN attempts exceeded. This session has been terminated for security reasons.';
        lockoutMessage.style.backgroundColor = '#dc3545';
        lockoutMessage.style.color = 'white';
        lockoutMessage.style.border = '2px solid #c82333';
        chatArea.appendChild(lockoutMessage);
    }
    
    // Disable the upload button specifically
    const addDocBtn = document.getElementById('addDocBtn');
    if (addDocBtn) {
        addDocBtn.disabled = true;
        addDocBtn.classList.remove('btn-primary', 'btn-secondary');
        addDocBtn.classList.add('btn-danger');
        addDocBtn.innerHTML = '<i class="fas fa-lock"></i> LOCKED';
    }
    
    // Add a visual overlay to indicate lockout
    const overlay = document.createElement('div');
    overlay.id = 'lockoutOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(220, 53, 69, 0.1);
        z-index: 9999;
        pointer-events: none;
    `;
    document.body.appendChild(overlay);
    
    // Update connection status to show "Locked Out"
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    if (statusIndicator && statusText) {
        statusIndicator.className = 'status-indicator status-disconnected';
        statusText.textContent = 'Locked Out';
        statusText.style.color = '#dc3545';
        statusText.style.fontWeight = 'bold';
    }
    
    // Log the lockout event
    addLogMessage('üîí SYSTEM LOCKOUT: Maximum PIN attempts exceeded. Session terminated.');
    
    // Optional: Redirect to a lockout page or show a modal
    setTimeout(() => {
        alert('Session terminated due to security violation.');
    }, 1000);
}

addDocBtn.addEventListener('click', function() {
    if (!uploadButtonUnlocked) {
        // Show pin prompt
        const pin = prompt('Enter security PIN to upload documents:');
        if (pin === null) {
            return; // User cancelled
        }
        if (pin === UPLOAD_PIN) {
            uploadPinCache = pin;
            uploadButtonUnlocked = true;
            this.innerHTML = '<i class="fas fa-plus"></i> Add Documents';
            this.classList.remove('btn-secondary');
            this.classList.add('btn-primary');
            alert('PIN verified! Upload button is now unlocked.');
        } else {
            wrongPinAttempts++;
            if (wrongPinAttempts >= MAX_PIN_ATTEMPTS) {
                alert('Maximum PIN attempts exceeded. System will now disconnect for security.');
                // Disconnect AI and kill web instance
                disconnectAndLockout();
            } else {
                const remainingAttempts = MAX_PIN_ATTEMPTS - wrongPinAttempts;
                alert(`Incorrect PIN. Access denied. ${remainingAttempts} attempt${remainingAttempts > 1 ? 's' : ''} remaining.`);
            }
        }
    } else {
        // Button is already unlocked, proceed with file selection
        addDocInput.click();
    }
});
addDocInput.addEventListener('change', (e) => {
    const files = e.target.files;
    if (files.length > 0) {
        // Show progress indicator
        const progressId = 'bulk-upload-progress';
        addLogMessage(`üì§ Starting bulk upload of ${files.length} document${files.length > 1 ? 's' : ''}...`, progressId);
        
        // Get current topic selection from Docs Management dropdown
        let topicIds = [];
        const topicDropdownMenu = document.getElementById('topicDropdownMenu');
        if (topicDropdownMenu) {
            topicIds = Array.from(topicDropdownMenu.querySelectorAll('.topic-checkbox:checked')).map(cb => cb.value);
        }
        
        // Use the new bulk upload endpoint
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }
        formData.append('topic_ids', JSON.stringify(topicIds));
        
        fetch('/bulk_upload_documents', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateLogMessage(progressId, `üì§ Bulk upload completed: ${data.successful_count} successful, ${data.failed_count} failed, ${data.conflict_count} conflicts`);
                
                // Log individual results
                data.results.forEach(result => {
                    if (result.status === 'success') {
                        addLogMessage(`‚úÖ ${result.filename}: ${result.message}`);
                    } else if (result.status === 'conflict') {
                        addLogMessage(`‚ö†Ô∏è ${result.filename}: ${result.message}`);
                        showConflictModal(result.message, result.filename);
                    } else {
                        addLogMessage(`‚ùå ${result.filename}: ${result.error}`);
                    }
                });
                
                // Refresh the document list immediately and then again after a delay
                loadDocuments();
                setTimeout(() => {
                    loadDocuments();
                }, 2000);
            } else {
                updateLogMessage(progressId, `‚ùå Bulk upload failed: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Bulk upload error:', error);
            updateLogMessage(progressId, `‚ùå Network error during bulk upload: ${error}`);
        });
    }
});

// --- Document Rename and Conflict Resolution Functions ---

let currentConflictData = null;

function showRenameModal(filename) {
    document.getElementById('renameOldFilename').value = filename;
    document.getElementById('renameNewFilename').value = filename;
    const modal = new bootstrap.Modal(document.getElementById('renameDocModal'));
    modal.show();
}

function showConflictModal(message, filename, oldFilename = null) {
    document.getElementById('conflictMessage').textContent = message;
    document.getElementById('newFilename').value = filename;
    currentConflictData = { filename, oldFilename };
    const modal = new bootstrap.Modal(document.getElementById('filenameConflictModal'));
    modal.show();
}

// Rename document functionality
document.getElementById('confirmRenameBtn').addEventListener('click', function() {
    const oldFilename = document.getElementById('renameOldFilename').value;
    const newFilename = document.getElementById('renameNewFilename').value;
    
    if (!newFilename.trim()) {
        alert('Please enter a new filename');
        return;
    }
    
    // Disable the button to prevent multiple clicks
    const confirmBtn = this;
    const originalText = confirmBtn.innerHTML;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Renaming...';
    
    // Check if new filename already exists
    fetch('/check_filename_conflict', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filename: newFilename })
    })
    .then(response => response.json())
    .then(data => {
        if (data.exists) {
            addLogMessage(`‚ö†Ô∏è File "${newFilename}" already exists. Please choose a different name.`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
            return;
        }
        
        // Proceed with rename
        return fetch('/rename_document', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                old_filename: oldFilename, 
                new_filename: newFilename 
            })
        });
    })
    .then(response => {
        if (response) {
            return response.json();
        }
        return null;
    })
    .then(data => {
        if (data && data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('renameDocModal')).hide();
            addLogMessage(`üìù Document renamed from "${oldFilename}" to "${newFilename}"`);
            // Add a small delay before refreshing to ensure file system operations complete
            setTimeout(() => {
                loadDocuments(); // Refresh the table
            }, 1000);
        } else if (data) {
            addLogMessage(`‚ùå Error renaming document: ${data.error}`);
        }
    })
    .catch(error => {
        addLogMessage(`‚ùå Error renaming document: ${error}`);
    })
    .finally(() => {
        // Re-enable the button
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalText;
    });
});

// Conflict resolution functionality
document.getElementById('renameConflictBtn').addEventListener('click', function() {
    const newFilename = document.getElementById('newFilename').value;
    
    if (!newFilename.trim()) {
        alert('Please enter a new filename');
        return;
    }
    
    // Disable the button to prevent multiple clicks
    const renameBtn = this;
    const originalText = renameBtn.innerHTML;
    renameBtn.disabled = true;
    renameBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    // Check if new filename already exists
    fetch('/check_filename_conflict', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filename: newFilename })
    })
    .then(response => response.json())
    .then(data => {
        if (data.exists) {
            addLogMessage(`‚ö†Ô∏è File "${newFilename}" already exists. Please choose a different name.`);
            renameBtn.disabled = false;
            renameBtn.innerHTML = originalText;
            return;
        }
        
        // Continue with the original upload/replace operation using the new filename
        if (currentConflictData && currentConflictData.oldFilename) {
            // This is a replace operation
            continueReplaceWithNewName(newFilename);
        } else {
            // This is an upload operation
            continueUploadWithNewName(newFilename);
        }
    })
    .catch(error => {
        addLogMessage(`‚ùå Error checking filename: ${error}`);
        renameBtn.disabled = false;
        renameBtn.innerHTML = originalText;
    });
});

document.getElementById('cancelConflictBtn').addEventListener('click', function() {
    bootstrap.Modal.getInstance(document.getElementById('filenameConflictModal')).hide();
    currentConflictData = null;
    // Clear file inputs
    addDocInput.value = '';
    bulkReplaceInput.value = '';
    const replaceInput = document.getElementById('replaceDocInput');
    if (replaceInput) replaceInput.value = '';
});

function continueUploadWithNewName(newFilename) {
    const files = addDocInput.files;
    if (files.length === 0) return;
    
    const file = files[0];
    const formData = new FormData();
    
    // Create a new file with the new name
    const newFile = new File([file], newFilename, { type: file.type });
    formData.append('file', newFile);
    formData.append('topic_ids', JSON.stringify(selectedTopics));
    
    fetch('/upload_document', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('filenameConflictModal')).hide();
        currentConflictData = null;
        
        // Re-enable the conflict resolution button
        const renameBtn = document.getElementById('renameConflictBtn');
        if (renameBtn) {
            renameBtn.disabled = false;
            renameBtn.innerHTML = 'Rename & Continue';
        }
        
        if (data.status === 'success') {
            addLogMessage(`üì§ Document "${newFilename}" uploaded successfully`);
            setTimeout(() => {
                loadDocuments();
            }, 1000);
        } else if (data.status === 'conflict') {
            showConflictModal(data.message, data.filename);
        } else {
            addLogMessage(`‚ùå Error uploading document: ${data.error}`);
        }
    })
    .catch(error => {
        addLogMessage(`‚ùå Error uploading document: ${error}`);
        // Re-enable the conflict resolution button
        const renameBtn = document.getElementById('renameConflictBtn');
        if (renameBtn) {
            renameBtn.disabled = false;
            renameBtn.innerHTML = 'Rename & Continue';
        }
    });
}

function continueReplaceWithNewName(newFilename) {
    const files = bulkReplaceInput.files;
    if (files.length === 0) return;
    
    const file = files[0];
    const formData = new FormData();
    
    // Create a new file with the new name
    const newFile = new File([file], newFilename, { type: file.type });
    formData.append('file', newFile);
    formData.append('old_filename', currentConflictData.oldFilename);
    formData.append('topic_ids', JSON.stringify(selectedTopics));
    
    fetch('/replace_document', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('filenameConflictModal')).hide();
        currentConflictData = null;
        
        // Re-enable the conflict resolution button
        const renameBtn = document.getElementById('renameConflictBtn');
        if (renameBtn) {
            renameBtn.disabled = false;
            renameBtn.innerHTML = 'Rename & Continue';
        }
        
        if (data.status === 'success') {
            addLogMessage(`üîÑ Document "${currentConflictData.oldFilename}" replaced with "${newFilename}"`);
            setTimeout(() => {
                loadDocuments();
            }, 1000);
        } else if (data.status === 'conflict') {
            showConflictModal(data.message, data.filename, data.old_filename);
        } else {
            addLogMessage(`‚ùå Error replacing document: ${data.error}`);
        }
    })
    .catch(error => {
        addLogMessage(`‚ùå Error replacing document: ${error}`);
        // Re-enable the conflict resolution button
        const renameBtn = document.getElementById('renameConflictBtn');
        if (renameBtn) {
            renameBtn.disabled = false;
            renameBtn.innerHTML = 'Rename & Continue';
        }
    });
}

// --- Topic Management Functions ---

let currentTopic = 'all';
let selectedTopics = [];
let topics = [];

function loadTopics(callback) {
    fetch('/get_topics')
    .then(response => response.json())
    .then(data => {
        if (data.topics) {
            topics = data.topics;
            updateTopicDropdown();
            if (callback) callback();
        } else {
            if (callback) callback();
        }
    })
    .catch(error => {
        console.error('Error loading topics:', error);
        if (callback) callback();
    });
}

function updateTopicDropdown() {
    const dropdownMenu = document.getElementById('topicDropdownMenu');
    const topicCheckboxes = document.getElementById('topicCheckboxes');
    
    // Clear existing topic checkboxes
    topicCheckboxes.innerHTML = '';
    
    // Add topic checkboxes
    topics.forEach(topic => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input topic-checkbox" type="checkbox" value="${topic.id}" id="topic_${topic.id}">
            <label class="form-check-label" for="topic_${topic.id}">
                üìÇ ${topic.name}
            </label>
        `;
        topicCheckboxes.appendChild(div);
    });
    
    // Add event listeners to checkboxes
    const checkboxes = topicCheckboxes.querySelectorAll('.topic-checkbox');
    console.log('Adding event listeners to', checkboxes.length, 'checkboxes');
         checkboxes.forEach(checkbox => {
         // Remove any existing event listeners
         checkbox.removeEventListener('change', updateSelectedTopics);
         // Add new event listener
         checkbox.addEventListener('change', function(e) {
             console.log('Checkbox changed:', checkbox.value, checkbox.checked);
             e.preventDefault();
             e.stopPropagation();
             // Force immediate update
             updateSelectedTopics();
         });
     });
     
     // Update delete button state
     updateDeleteTopicsButton();
 }

function updateSelectedTopics() {
    console.log('updateSelectedTopics called');
    const checkboxes = document.querySelectorAll('.topic-checkbox:checked');
    selectedTopics = Array.from(checkboxes).map(cb => cb.value);
    
    console.log('Selected topics:', selectedTopics);
    
    // Update dropdown button text
    if (selectedTopics.length === 0) {
        document.getElementById('currentTopicName').textContent = 'All Topics';
        currentTopic = 'all';
    } else if (selectedTopics.length === 1) {
        const topic = topics.find(t => t.id == selectedTopics[0]);
        document.getElementById('currentTopicName').textContent = topic ? topic.name : 'Unknown Topic';
        currentTopic = selectedTopics[0];
    } else {
        document.getElementById('currentTopicName').textContent = `${selectedTopics.length} Topics Selected`;
        currentTopic = 'multiple';
    }
    
         addLogMessage(`üìÇ Selected topics: ${selectedTopics.length > 0 ? selectedTopics.map(id => topics.find(t => t.id == id)?.name).join(', ') : 'All Topics'}`);
     
     // Update delete button state
     updateDeleteTopicsButton();
     
     // Force immediate reload of documents
     console.log('Calling loadDocuments with topic:', currentTopic);
     loadDocuments();
 }

function switchTopic(topicId) {
    currentTopic = topicId;
    selectedTopics = topicId === 'all' ? [] : [topicId];
    
    // Update checkboxes
    const checkboxes = document.querySelectorAll('.topic-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectedTopics.includes(checkbox.value);
    });
    
    const topicName = topicId === 'all' ? 'All Topics' : topics.find(t => t.id === topicId)?.name || 'Unknown Topic';
    document.getElementById('currentTopicName').textContent = topicName;
    
    // Load documents for this topic
    loadDocuments();
    
    addLogMessage(`üìÇ Switched to topic: ${topicName}`);
}

// Update loadDocuments to filter by topic
function loadDocuments() {
    const cacheBuster = Date.now();
    console.log('Loading documents for topic:', currentTopic, 'selectedTopics:', selectedTopics);
    
    let url = `/get_documents?cb=${cacheBuster}&topic=${currentTopic}`;
    if (currentTopic === 'multiple' && selectedTopics.length > 0) {
        url += `&selected_topics=${JSON.stringify(selectedTopics)}`;
    }
    
    console.log('Fetching URL:', url);
    
    // Show loading state
    docsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading documents...</td></tr>';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('Documents response:', data);
            if (data.documents) {
                // Backend now handles all filtering, just use the returned documents
                docsList = data.documents;
                console.log('Documents loaded:', docsList.length, docsList);
                renderDocsTable();
                updateBulkButtons();
            } else {
                console.error('Error loading documents:', data.error);
                docsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Error loading documents</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error fetching documents:', error);
            docsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Error loading documents</td></tr>';
        });
}

// Topic dropdown event listeners
document.addEventListener('click', function(e) {
    if (e.target.matches('[data-topic]')) {
        e.preventDefault();
        const topicId = e.target.getAttribute('data-topic');
        switchTopic(topicId);
    }
});

// Create topic button
document.getElementById('createTopicBtn').addEventListener('click', function(e) {
    e.preventDefault();
    const modal = new bootstrap.Modal(document.getElementById('createTopicModal'));
    modal.show();
});

 // Create topic functionality
 document.getElementById('confirmCreateTopicBtn').addEventListener('click', function() {
     const topicName = document.getElementById('topicName').value.trim();
     const topicDescription = document.getElementById('topicDescription').value.trim();
     
     if (!topicName) {
         addLogMessage('‚ö†Ô∏è Please enter a topic name');
         return;
     }
     
     fetch('/create_topic', {
         method: 'POST',
         headers: {
             'Content-Type': 'application/json',
         },
         body: JSON.stringify({
             name: topicName,
             description: topicDescription
         })
     })
     .then(response => response.json())
     .then(data => {
         if (data.status === 'success') {
             bootstrap.Modal.getInstance(document.getElementById('createTopicModal')).hide();
             addLogMessage(`üìÇ Created new topic: "${topicName}"`);
             
             // Clear form
             document.getElementById('topicName').value = '';
             document.getElementById('topicDescription').value = '';
             
             // Reload topics and switch to the new topic
             loadTopics();
             setTimeout(() => {
                 switchTopic(data.topic_id);
             }, 500);
         } else {
             addLogMessage(`‚ùå Error creating topic: ${data.error}`);
         }
     })
     .catch(error => {
         addLogMessage(`‚ùå Error creating topic: ${error}`);
     });
 });
 
 // Delete topics functionality
 document.getElementById('deleteTopicsBtn').addEventListener('click', function() {
     if (selectedTopics.length === 0) {
         addLogMessage('‚ö†Ô∏è Please select topics to delete');
         return;
     }
     
     // Show custom confirmation modal
     const topicNames = selectedTopics.map(id => topics.find(t => t.id == id)?.name).filter(Boolean);
     const topicsList = document.getElementById('topicsToDeleteList');
     topicsList.innerHTML = '';
     
     topicNames.forEach(name => {
         const li = document.createElement('li');
         li.className = 'list-group-item';
         li.innerHTML = `<i class="fas fa-tag text-primary"></i> ${name}`;
         topicsList.appendChild(li);
     });
     
     const modal = new bootstrap.Modal(document.getElementById('deleteTopicsModal'));
     modal.show();
 });
 
 function updateDeleteTopicsButton() {
     const deleteBtn = document.getElementById('deleteTopicsBtn');
     if (deleteBtn) {
         deleteBtn.disabled = selectedTopics.length === 0;
     }
 }
 
 // Confirm delete topics functionality
 document.getElementById('confirmDeleteTopicsBtn').addEventListener('click', function() {
     // Disable the button to prevent multiple clicks
     const confirmBtn = this;
     const originalText = confirmBtn.innerHTML;
     confirmBtn.disabled = true;
     confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
     
     fetch('/delete_topics', {
         method: 'POST',
         headers: {
             'Content-Type': 'application/json',
         },
         body: JSON.stringify({
             topic_ids: selectedTopics
         })
     })
     .then(response => response.json())
     .then(data => {
         if (data.status === 'success') {
             addLogMessage(`üóëÔ∏è ${data.message}`);
             
             // Clear selected topics and reset to All Topics
             selectedTopics = [];
             currentTopic = 'all';
             document.getElementById('currentTopicName').textContent = 'All Topics';
             
             // Close modal
             bootstrap.Modal.getInstance(document.getElementById('deleteTopicsModal')).hide();
             
             // Reload topics, then load all documents after dropdown is rebuilt
             loadTopics(() => {
                 loadDocuments();
             });
         } else {
             addLogMessage(`‚ùå Error deleting topics: ${data.error}`);
         }
     })
     .catch(error => {
         addLogMessage(`‚ùå Error deleting topics: ${error}`);
     })
     .finally(() => {
         // Re-enable the button
         confirmBtn.disabled = false;
         confirmBtn.innerHTML = originalText;
     });
 });

// --- End Topic Management Functions ---

// --- End Document Rename and Conflict Resolution Functions ---

// Load documents and topics when page loads
loadDocuments();
loadTopics();

 // Initialize topic checkboxes after topics are loaded
 setTimeout(() => {
     console.log('Initializing topic checkboxes...');
     updateTopicDropdown();
     
     // Set initial state
     selectedTopics = [];
     currentTopic = 'all';
     document.getElementById('currentTopicName').textContent = 'All Topics';
     
     // Initialize delete button state
     updateDeleteTopicsButton();
 }, 500);
 // Confirm bulk delete functionality
 document.getElementById('confirmBulkDeleteBtn').addEventListener('click', function() {
     const selectedDocs = getSelectedDocuments();
     
     // Close modal
     bootstrap.Modal.getInstance(document.getElementById('bulkDeleteModal')).hide();
     
     // Show progress indicator
     const progressId = 'bulk-delete-progress';
     addLogMessage(`üóëÔ∏è Starting bulk deletion of ${selectedDocs.length} document${selectedDocs.length > 1 ? 's' : ''}...`, progressId);
     
     // Use the new bulk delete endpoint
     fetch('/bulk_delete_documents', {
         method: 'POST',
         headers: {
             'Content-Type': 'application/json',
         },
         body: JSON.stringify({filenames: selectedDocs})
     })
     .then(response => response.json())
     .then(data => {
         if (data.status === 'success') {
             updateLogMessage(progressId, `üóëÔ∏è Bulk delete completed: ${data.successful_count} successful, ${data.failed_count} failed`);
             
             // Log individual results
             data.results.forEach(result => {
                 if (result.status === 'success') {
                     addLogMessage(`‚úÖ ${result.filename}: ${result.message}`);
                 } else {
                     addLogMessage(`‚ùå ${result.filename}: ${result.error}`);
                 }
             });
             
             // Refresh the document list immediately and then again after a delay
             loadDocuments();
             setTimeout(() => {
                 loadDocuments();
             }, 2000);
         } else {
             updateLogMessage(progressId, `‚ùå Bulk delete failed: ${data.error}`);
         }
     })
     .catch(error => {
         console.error('Bulk delete error:', error);
         updateLogMessage(progressId, `‚ùå Network error during bulk delete: ${error}`);
     });
 });
 
 // Confirm bulk replace functionality
 document.getElementById('confirmBulkReplaceBtn').addEventListener('click', function() {
     // Close modal
     bootstrap.Modal.getInstance(document.getElementById('bulkReplaceModal')).hide();
     
     // Trigger file input for replacement files
     const bulkReplaceInput = document.getElementById('bulkReplaceInput');
     bulkReplaceInput.click();
 });
 
 // --- End Document Management UI Logic ---

// Comment out delete animation usage
// const stopAnimation = showDeleteAnimation();

function updateSortArrows() {
    document.querySelectorAll('.sort-arrow').forEach(arrow => {
        const col = arrow.getAttribute('data-col');
        const idx = sortLevels.findIndex(s => s.column === col);
        if (idx === 0) {
            arrow.innerHTML = sortLevels[0].direction === 'asc' ? '‚ñ≤' : '‚ñº';
        } else if (idx > 0) {
            // Arrow plus clickable superscript number
            arrow.innerHTML = (sortLevels[idx].direction === 'asc' ? '‚ñ≤' : '‚ñº') + `<sup style="cursor:pointer;">${String.fromCharCode(0x2460 + idx - 1)}</sup>`;
        } else {
            arrow.textContent = '‚ñ≤‚ñº';
        }
    });
}

// Patch renderDocsTable to call updateSortArrows after rendering
const originalRenderDocsTable = renderDocsTable;
renderDocsTable = function() {
    // Always sort docsList using current sortLevels before rendering
    docsList.sort((a, b) => {
        for (let { column, direction } of sortLevels) {
            let av = a[column], bv = b[column];
            if (column === 'topics') {
                av = (a.tags || []).join(',');
                bv = (b.tags || []).join(',');
            }
            if (column === 'name') {
                av = av ? av.toLowerCase() : '';
                bv = bv ? bv.toLowerCase() : '';
            }
            if (av < bv) return direction === 'asc' ? -1 : 1;
            if (av > bv) return direction === 'asc' ? 1 : -1;
        }
        return 0;
    });
    originalRenderDocsTable();
    updateSortArrows();
};

// Add popup menu for multi-level sort order selection
function showSortOrderPopup(arrow, col, idx) {
    // Remove any existing popup
    const existing = document.getElementById('sortOrderPopup');
    if (existing) existing.remove();
    const popup = document.createElement('div');
    popup.id = 'sortOrderPopup';
    popup.style.position = 'absolute';
    popup.style.background = '#fff';
    popup.style.border = '1px solid #ccc';
    popup.style.borderRadius = '6px';
    popup.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
    popup.style.padding = '4px 8px';
    popup.style.zIndex = 10000;
    popup.style.display = 'flex';
    popup.style.gap = '6px';
    // Get arrow position
    const rect = arrow.getBoundingClientRect();
    popup.style.left = `${rect.left + window.scrollX}px`;
    popup.style.top = `${rect.top + window.scrollY - 32}px`;
    // Add ‚ì™ for main sorter
    const zero = document.createElement('span');
    zero.textContent = '‚ì™';
    zero.style.cursor = 'pointer';
    zero.style.fontSize = '1.2em';
    zero.style.padding = '0 4px';
    if (idx === 0) {
        zero.style.fontWeight = 'bold';
        zero.style.color = '#B0E0E6';
    }
    zero.title = 'Make main sorter';
    zero.addEventListener('click', function(e) {
        e.stopPropagation();
        const currentIdx = sortLevels.findIndex(s => s.column === col);
        if (currentIdx !== -1) {
            const [item] = sortLevels.splice(currentIdx, 1);
            sortLevels.unshift(item);
            renderDocsTable();
            updateSortArrows();
        }
        popup.remove();
    });
    popup.appendChild(zero);
    // Add numbers 1 to N
    for (let i = 1; i <= sortLevels.length; i++) {
        const num = document.createElement('span');
        num.textContent = String.fromCharCode(0x2460 + i - 1); // ‚ë†, ‚ë°, ‚ë¢ ...
        num.style.cursor = 'pointer';
        num.style.fontSize = '1.2em';
        num.style.padding = '0 4px';
        if (i - 1 === idx) {
            num.style.fontWeight = 'bold';
            num.style.color = '#B0E0E6';
        }
        num.title = `Make sort order ${i}`;
        num.addEventListener('click', function(e) {
            e.stopPropagation();
            // Move col to this position
            const currentIdx = sortLevels.findIndex(s => s.column === col);
            if (currentIdx !== -1) {
                const [item] = sortLevels.splice(currentIdx, 1);
                sortLevels.splice(i - 1, 0, item);
                renderDocsTable();
                updateSortArrows();
            }
            popup.remove();
        });
        popup.appendChild(num);
    }
    // Add remove (√ó) button
    const removeBtn = document.createElement('span');
    removeBtn.textContent = '√ó';
    removeBtn.style.cursor = 'pointer';
    removeBtn.style.fontSize = '1.2em';
    removeBtn.style.color = '#dc3545';
    removeBtn.style.marginLeft = '8px';
    removeBtn.title = 'Remove from sorting';
    removeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const currentIdx = sortLevels.findIndex(s => s.column === col);
        if (currentIdx !== -1) {
            sortLevels.splice(currentIdx, 1);
            if (sortLevels.length === 0) {
                sortLevels = [{ column: 'topics', direction: 'asc' }];
            }
            renderDocsTable();
            updateSortArrows();
        }
        popup.remove();
    });
    popup.appendChild(removeBtn);
    document.body.appendChild(popup);
    // Remove popup on outside click
    setTimeout(() => {
        document.addEventListener('mousedown', function handler(e) {
            if (!popup.contains(e.target)) {
                popup.remove();
                document.removeEventListener('mousedown', handler);
            }
        });
    }, 0);
}

// --- Patch chat send logic ---
function getSelectedChatTopicIds() {
    const menu = document.getElementById('chatTopicsDropdownMenu');
    if (!menu) return ['none'];
    const checked = menu.querySelectorAll('.form-check-input:checked');
    if (checked.length === 0) return ['none'];
    return Array.from(checked).map(cb => cb.value);
}
function getCurrentChatSessionKey() {
    const selected = getSelectedChatTopicIds();
    if (!selected || selected.length === 0 || selected.includes('all')) {
        return 'topics:all';
    }
    const sorted = [...selected].sort();
    return 'topics:' + sorted.join(',');
}
const askButton = document.getElementById('askButton');
const questionInput = document.getElementById('questionInput');
if (askButton && questionInput) {
    askButton.addEventListener('click', sendChatQuestion);
    questionInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey && !questionInput.disabled && !questionInput.readOnly) {
            e.preventDefault();
            sendChatQuestion();
        }
    });
}
function sendChatQuestion() {
    const input = document.getElementById('questionInput');
    const askButton = document.getElementById('askButton');
    // Prevent sending if input or button is disabled or readOnly
    if (!input || !askButton || input.disabled || input.readOnly || askButton.disabled) {
        return;
    }
    const question = input.value.trim();
    if (!question) return;
    const topic_ids = getSelectedChatTopicIds();
    const session_key = getCurrentChatSessionKey();
    addMessage('üßë You: ' + question, 'user');
    input.value = '';
    const thinkingMessage = document.createElement('div');
    thinkingMessage.className = 'message ai-message';
    thinkingMessage.id = 'thinkingMessage';
    thinkingMessage.innerHTML = '<span style="font-size:2em">ü§ñ</span> <em>Thinking...</em>';
    document.getElementById('chatMessages').appendChild(thinkingMessage);
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, topic_ids, session_key })
    })
    .then(response => response.json())
    .then(data => {
        const thinkingMsg = document.getElementById('thinkingMessage');
        if (thinkingMsg) thinkingMsg.remove();
        if (data.error) {
            addMessage('‚ùå Error: ' + data.error, 'ai');
        } else {
            // Create the AI response container
            let aiResponse = 'ü§ñ <strong>AI:</strong> ';
            
            // Always show the helpful answer first
            aiResponse += '<span class="helpful-answer">' + data.answer + '</span>';
            
            // Always show the detailed answer toggle
            aiResponse += ' <span class="detailed-toggle" onclick="toggleDetailedAnswer(this)" data-detailed="' + (data.detailed_answer || '').replace(/"/g, '&quot;').replace(/\n/g, '<br>') + '">Detailed Answer ‚ñº</span>';
            
            // Add confidence if available
            if (data.confidence) {
                aiResponse += '<br><strong>Confidence:</strong> ' + data.confidence + '%';
            }
            
            // Add sources if available
            if (data.sources) {
                if (typeof data.sources === 'object' && data.sources.summary && data.sources.detailed) {
                    aiResponse += '<br><strong>Sources:</strong> <span class="source-summary">' + data.sources.summary + '</span> <span class="source-toggle" onclick="toggleSourceDetails(this)" data-detailed="' + data.sources.detailed.replace(/"/g, '&quot;') + '">‚ñº</span>';
                } else {
                    aiResponse += '<br><strong>Sources:</strong> ' + data.sources;
                }
            }
            
            addMessage(aiResponse, 'ai');
            // Update chatHistories cache for this session
            if (!window.chatHistories) window.chatHistories = {};
            if (!window.chatHistories[session_key]) window.chatHistories[session_key] = [];
            window.chatHistories[session_key].push({ question, answer: data.answer });
        }
    })
    .catch(error => {
        const thinkingMsg = document.getElementById('thinkingMessage');
        if (thinkingMsg) thinkingMsg.remove();
        addMessage('‚ùå Error: ' + error, 'ai');
    });
}

// Patch Docs Management topic selection logic
window.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    // Docs Management topic dropdown logic
    const topicDropdownMenu = document.getElementById('topicDropdownMenu');
    const topicDropdownBtn = document.getElementById('topicDropdown');
    if (topicDropdownMenu && topicDropdownBtn) {
        topicDropdownMenu.addEventListener('change', function(e) {
            const checkboxes = topicDropdownMenu.querySelectorAll('.topic-checkbox');
            const checked = Array.from(checkboxes).filter(cb => cb.checked);
            // If All Topics is checked, uncheck all others
            if (checked.some(cb => cb.value === 'all')) {
                checkboxes.forEach(cb => { cb.checked = (cb.value === 'all'); });
            } else {
                // If any other is checked, uncheck All Topics
                if (checked.length > 0) {
                    topicDropdownMenu.querySelector('.topic-checkbox[value="all"]').checked = false;
                }
                // If none checked, check All Topics
                const anyChecked = Array.from(checkboxes).some(cb => cb.value !== 'all' && cb.checked);
                if (!anyChecked) {
                    topicDropdownMenu.querySelector('.topic-checkbox[value="all"]').checked = true;
                }
            }
            // Trigger document reload
            loadDocuments();
        });
    }
});

// Add a button to refresh backend logs in the Logs tab
// Place this inside the logsArea div, e.g.:
// <button class="btn btn-outline-secondary mb-2" id="refreshBackendLogsBtn">Refresh Backend Logs</button>
// ... existing code ...
// Add this JS near the other event listeners:
let backendLogsInterval = null;

function fetchBackendLogs() {
    fetch('/get_backend_logs')
        .then(response => response.json())
        .then(data => {
            const logsContent = document.getElementById('logsContent');
            if (!logsContent) return;
            
            // Clear only the log messages, not the welcome message
            const messages = logsContent.querySelectorAll('.message');
            messages.forEach((message, index) => {
                if (index > 0) { // Keep the first message (welcome message)
                    message.remove();
                }
            });
            
            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(line => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message ai-message';
                    messageDiv.textContent = line.trim();
                    logsContent.appendChild(messageDiv);
                });
                // Removed auto-scroll to allow manual scrolling
            } else if (data.error) {
                addLogMessage('‚ùå Error fetching backend logs: ' + data.error);
            } else {
                // No logs yet
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.textContent = 'üìù This is where system logs will show up.';
                logsContent.appendChild(messageDiv);
            }
        });
}

// Start/stop polling when Logs tab is shown/hidden
const logsTabBtn = document.getElementById('logsTabBtn');
if (logsTabBtn) {
    logsTabBtn.addEventListener('click', function() {
        fetchBackendLogs();
        if (backendLogsInterval) clearInterval(backendLogsInterval);
        backendLogsInterval = setInterval(fetchBackendLogs, 2000); // Poll every 2 seconds
    });
}

// Stop polling when switching away from Logs tab
const chatTabBtn = document.getElementById('chatTabBtn');
const docsTabBtn = document.getElementById('docsTabBtn');
function stopBackendLogsInterval() {
    if (backendLogsInterval) {
        clearInterval(backendLogsInterval);
        backendLogsInterval = null;
    }
}
if (chatTabBtn) chatTabBtn.addEventListener('click', stopBackendLogsInterval);
if (docsTabBtn) docsTabBtn.addEventListener('click', stopBackendLogsInterval);

// Clear backend logs when page is unloaded (session ends)
window.addEventListener('beforeunload', function() {
    // Clear backend logs
    fetch('/clear_backend_logs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).catch(error => {
        // Ignore errors when page is unloading
        console.log('Could not clear logs:', error);
    });
    
    // Clear guest session data when page is unloaded
    // This ensures guest users don't persist data between visits
    if (!window.isLoggedInUser) {  // Check if this is a guest user
        fetch('/clear_guest_session_on_exit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).catch(error => {
            // Ignore errors when page is unloading
            console.log('Could not clear guest session:', error);
        });
    }
});

// Clear displayed logs button functionality
const clearLogsBtn = document.getElementById('clearLogsBtn');
if (clearLogsBtn) {
    clearLogsBtn.addEventListener('click', function() {
        // Clear the backend log file first
        fetch('/clear_backend_logs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(() => {
            // Then clear the displayed logs
            const logsContent = document.getElementById('logsContent');
            if (logsContent) {
                            // Clear all messages except the welcome message
            const messages = logsContent.querySelectorAll('.message');
            messages.forEach((message, index) => {
                // Keep only the first message (welcome message), remove all others
                if (index > 0) {
                    message.remove();
                }
            });
            }
        }).catch(error => {
            console.log('Could not clear backend logs:', error);
        });
    });
}
// ... existing code ...

// Old function removed - using updateChatBarAndBatchQnAState instead

// ... existing code ...
// Chat topics dropdown logic is now handled in attachChatTopicsDropdownHandler()
// ... existing code ...
// On page load, ensure the correct state:
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking elements...');
    const menu = document.getElementById('chatTopicsDropdownMenu');
    console.log('Menu found on load:', menu);
    setTimeout(updateUploadQuestionnaireButton, 200); // Delay to ensure DOM is ready
    
    // Check user status on page load to set guest user flag
    checkUserStatus();
});
// ... existing code ...

// --- BEGIN: Separate logic for Upload Questionnaire button ---
function updateUploadQuestionnaireButton() {
    const menu = document.getElementById('chatTopicsDropdownMenu');
    const batchQnAButton = document.getElementById('batchQnAButton');
    console.log('Menu element:', menu);
    console.log('Button element:', batchQnAButton);
    if (!menu || !batchQnAButton) {
        console.log('Menu or button not found!');
        return;
    }
    
    const checked = menu.querySelectorAll('.form-check-input:checked');
    console.log('updateUploadQuestionnaireButton called, checked topics:', checked.length);
    console.log('Checked elements:', checked);
    
    // Debug: Log each checked checkbox value
    Array.from(checked).forEach((cb, index) => {
        console.log(`Checked checkbox ${index}: value="${cb.value}", id="${cb.id}"`);
    });
    
    // No topics selected - improved logic
    const hasValidTopics = Array.from(checked).some(cb => cb.value !== 'none');
    console.log('Has valid topics:', hasValidTopics);
    
    if (!hasValidTopics) {
        console.log('No valid topics selected, disabling button');
        batchQnAButton.disabled = true;
        batchQnAButton.classList.add('disabled-btn');
        batchQnAButton.setAttribute('title', 'Select topics with documents to enable Upload Questionnaire');
        batchQnAButton.innerHTML = '<i class="fas fa-question-circle"></i> Upload Questionnaire (No Topics)';
        return;
    }
    
    console.log('Valid topics found, proceeding with document check');
    
    // Get selected topic IDs
    const selectedTopicIds = Array.from(checked)
        .filter(cb => cb.value !== 'none' && cb.value !== 'all')
        .map(cb => parseInt(cb.value)).filter(id => !isNaN(id));
    
    // Check if 'All Topics' is selected
    const isAllTopics = Array.from(checked).some(cb => cb.value === 'all');
    
    // Show loading state while checking
    batchQnAButton.disabled = true;
    batchQnAButton.classList.add('disabled-btn');
    batchQnAButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking Documents...';
    
    // For 'All Topics', check if any documents exist
    if (isAllTopics) {
        console.log('Checking All Topics for documents');
        fetch('/has_documents_for_topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic_ids: [] })
        })
        .then(response => response.json())
        .then(data => {
            console.log('API response for All Topics:', data);
            if (data.has_documents) {
                batchQnAButton.disabled = false;
                batchQnAButton.classList.remove('disabled-btn');
                batchQnAButton.setAttribute('title', '');
                batchQnAButton.innerHTML = '<i class="fas fa-question-circle"></i> Upload Questionnaire';
            } else {
                batchQnAButton.disabled = true;
                batchQnAButton.classList.add('disabled-btn');
                batchQnAButton.setAttribute('title', 'No documents found for selected topics');
                batchQnAButton.innerHTML = '<i class="fas fa-question-circle"></i> Upload Questionnaire (No Docs)';
            }
        })
        .catch(() => {
            batchQnAButton.disabled = true;
            batchQnAButton.classList.add('disabled-btn');
            batchQnAButton.setAttribute('title', 'Error checking documents');
            batchQnAButton.innerHTML = '<i class="fas fa-question-circle"></i> Upload Questionnaire (Error)';
        });
    } else {
        // For specific topics, check if documents exist for those topics
        console.log('Checking specific topics for documents:', selectedTopicIds);
        fetch('/has_documents_for_topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic_ids: selectedTopicIds })
        })
        .then(response => response.json())
        .then(data => {
            console.log('API response for specific topics:', data);
            if (data.has_documents) {
                batchQnAButton.disabled = false;
                batchQnAButton.classList.remove('disabled-btn');
                batchQnAButton.setAttribute('title', '');
                batchQnAButton.innerHTML = '<i class="fas fa-question-circle"></i> Upload Questionnaire';
            } else {
                batchQnAButton.disabled = true;
                batchQnAButton.classList.add('disabled-btn');
                batchQnAButton.setAttribute('title', 'No documents found for selected topics');
                batchQnAButton.innerHTML = '<i class="fas fa-question-circle"></i> Upload Questionnaire (No Docs)';
            }
        })
        .catch(() => {
            batchQnAButton.disabled = true;
            batchQnAButton.classList.add('disabled-btn');
            batchQnAButton.setAttribute('title', 'Error checking documents');
            batchQnAButton.innerHTML = '<i class="fas fa-question-circle"></i> Upload Questionnaire (Error)';
        });
    }
}
// --- END: Separate logic for Upload Questionnaire button ---

// Duplicate event listeners removed - using the ones above
// ... existing code ...

// Add source dropdown toggle functionality
function toggleSourceDetails(toggleElement) {
    const sourceInfo = toggleElement.closest('.source-info');
    const summary = sourceInfo.querySelector('.source-summary');
    const detailed = sourceInfo.querySelector('.source-detailed');
    
    if (detailed) {
        // Toggle existing detailed view
        detailed.remove();
        toggleElement.textContent = '‚ñº';
    } else {
        // Show detailed view
        const detailedDiv = document.createElement('div');
        detailedDiv.className = 'source-detailed';
        detailedDiv.style.marginTop = '5px';
        detailedDiv.style.padding = '8px';
        detailedDiv.style.backgroundColor = '#f8f9fa';
        detailedDiv.style.border = '1px solid #dee2e6';
        detailedDiv.style.borderRadius = '4px';
        detailedDiv.style.fontSize = '0.9em';
        detailedDiv.style.color = '#6c757d';
        detailedDiv.style.maxWidth = '100%';
        detailedDiv.style.maxHeight = '200px';
        detailedDiv.style.overflow = 'auto';
        detailedDiv.style.whiteSpace = 'pre-wrap';
        detailedDiv.style.wordBreak = 'break-word';
        detailedDiv.textContent = toggleElement.getAttribute('data-detailed');
        
        summary.parentNode.insertBefore(detailedDiv, toggleElement);
        toggleElement.textContent = '‚ñ≤';
    }
}

// Add detailed answer toggle functionality
function toggleDetailedAnswer(toggleElement) {
    // Get the message container
    const messageDiv = toggleElement.closest('.message');
    
    // Check if detailed answer already exists
    const existingDetailed = messageDiv.querySelector('.detailed-answer');
    
    if (existingDetailed) {
        // Hide detailed answer
        existingDetailed.remove();
        toggleElement.textContent = 'Detailed Answer ‚ñº';
    } else {
        // Get the detailed content from the toggle element
        const detailedContent = toggleElement.getAttribute('data-detailed');
        
        // Only show detailed answer if there's content
        if (detailedContent && detailedContent.trim() !== '') {
            // Show detailed answer
            const detailedDiv = document.createElement('div');
            detailedDiv.className = 'detailed-answer';
            detailedDiv.style.cssText = `
                margin-top: 10px;
                padding: 12px;
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                font-size: 1em;
                color: #495057;
                max-width: 100%;
                white-space: pre-wrap;
                word-break: break-word;
                line-height: 1.5;
            `;
            
            detailedDiv.innerHTML = detailedContent;
            
            // Insert the detailed answer right after the helpful answer
            const helpfulAnswer = messageDiv.querySelector('.helpful-answer');
            if (helpfulAnswer) {
                helpfulAnswer.parentNode.insertBefore(detailedDiv, toggleElement);
            } else {
                // Fallback: insert before the toggle element
                toggleElement.parentNode.insertBefore(detailedDiv, toggleElement);
            }
            
            // Change toggle text
            toggleElement.textContent = 'Detailed Answer ‚ñ≤';
        } else {
            // No detailed content available
            alert('No detailed answer available for this response.');
        }
    }
}

function monitorQuestionnaireProgress(jobId) {
    const progressInterval = setInterval(() => {
        fetch(`/questionnaire_progress/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                clearInterval(progressInterval);
                addLogMessage(`‚ùå Error tracking progress: ${data.error}`);
                return;
            }
            
            // Update progress display
            if (data.status === 'processing') {
                const progress = Math.round((data.completed_questions / data.total_questions) * 100);
                updateLogMessage(`üîÑ ${data.message} (${progress}% complete)`);
                
                if (data.current_question) {
                    addLogMessage(`üìù ${data.current_question}`);
                }
            } else if (data.status === 'completed') {
                clearInterval(progressInterval);
                addLogMessage(`‚úÖ Questionnaire processing complete!`);
                addLogMessage(`üìä Processed ${data.completed_questions} questions successfully`);
                
                // Show download link
                showQuestionnaireResults(jobId);
            } else if (data.status === 'error') {
                clearInterval(progressInterval);
                addLogMessage(`‚ùå Processing failed: ${data.message}`);
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            addLogMessage(`‚ùå Error checking progress: ${error}`);
        });
    }, 2000); // Check every 2 seconds
}

function showQuestionnaireResults(jobId) {
    console.log(`Fetching results for job: ${jobId}`);
    // Fetch the final results and show download link
    fetch(`/questionnaire_results/${jobId}`)
    .then(response => {
        console.log(`Response status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        console.log('Received data:', data);
        if (data.error) {
            addLogMessage(`‚ùå Error getting results: ${data.error}`);
            return;
        }
        
        // Show success message with download link
        addLogMessage(`üéâ All questions processed successfully!`);
        addLogMessage(`üìä Processed ${data.questions ? data.questions.length : 0} questions`);
        
        // Create and show download link
        if (data.csv_id) {
            const downloadLink = document.createElement('div');
            downloadLink.className = 'download-section';
            downloadLink.style.cssText = `
                margin: 15px 0;
                padding: 15px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                border-radius: 10px;
                text-align: center;
                color: white;
            `;
            
            downloadLink.innerHTML = `
                <h5 style="margin: 0 0 10px 0; color: white;">üì• Download Results</h5>
                <p style="margin: 0 0 15px 0; font-size: 0.9em;">Your questionnaire results are ready!</p>
                <a href="/download_csv/${data.csv_id}" 
                   class="btn btn-light btn-lg" 
                   download="${data.filename || 'questionnaire_results.csv'}"
                   style="text-decoration: none; font-weight: 600;">
                    <i class="fas fa-download"></i> Download CSV
                </a>
                <p style="margin: 10px 0 0 0; font-size: 0.8em; opacity: 0.9;">
                    File will be automatically cleaned up after download
                </p>
            `;
            
            // Add the download section to the chat area
            const chatArea = document.querySelector('.chat-area');
            if (chatArea) {
                chatArea.appendChild(downloadLink);
            }
        }
        
        // Hide the panel and reset
        const batchQnAPanel = document.getElementById('batchQnAPanel');
        if (batchQnAPanel) batchQnAPanel.classList.add('hidden');
        
        // Clear the file input
        const batchQnAInput = document.getElementById('batchQnAInput');
        if (batchQnAInput) batchQnAInput.value = '';
        
        const batchQnAFileName = document.getElementById('batchQnAFileName');
        if (batchQnAFileName) batchQnAFileName.textContent = '';
        
        const batchQnAUploadBtn = document.getElementById('batchQnAUploadBtn');
        if (batchQnAUploadBtn) batchQnAUploadBtn.disabled = true;
    })
    .catch(error => {
        addLogMessage(`‚ùå Error fetching results: ${error}`);
    });
}
    </script>
</body>
</html> 